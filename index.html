<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grade Calculator</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <!-- Chart.js for the Dashboard -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- CSS VARIABLES (THEMING) --- */
        :root {
            --bg-color: #f4f7f6;
            --container-bg: #ffffff;
            --text-main: #333333;
            --text-secondary: #555555;
            --text-muted: #7f8c8d;
            --heading-color: #2c3e50;
            --border-color: #ecf0f1;
            --th-bg: #f8f9fa;
            --input-bg: #ffffff;
            --input-border: #cccccc;
            --input-text: #333333;
            --accent-color: #3498db;
            --accent-hover: #2980b9;
            --percent-text: #2980b9;
            --delete-btn: #e74c3c;
            --delete-hover: #c0392b;
            --result-box-bg: #ecf0f1;
            --goal-box-bg: #e8f6f3;
            --goal-border: #1abc9c;
            --shadow: 0 4px 15px rgba(0,0,0,0.1);

            /* Stats Modal Light Theme */
            --modal-bg: #ffffff;
            --modal-text: #333333;
            --modal-border: #e0e0e0;
            --card-bg: #f8f9fa;
            --chart-grid: #e5e5e5;
            --chart-text: #666666;
            --close-btn-hover: #333333;
        }

        [data-theme="dark"] {
            --bg-color: #121212;
            --container-bg: #1e1e1e;
            --text-main: #e0e0e0;
            --text-secondary: #b0b0b0;
            --text-muted: #a0a0a0;
            --heading-color: #ffffff;
            --border-color: #333333;
            --th-bg: #2c2c2c;
            --input-bg: #2d2d2d;
            --input-border: #444444;
            --input-text: #ffffff;
            --accent-color: #3498db;
            --accent-hover: #5dade2;
            --percent-text: #5dade2;
            --delete-btn: #cf6679;
            --delete-hover: #b00020;
            --result-box-bg: #2d2d2d;
            --goal-box-bg: #1a3a34;
            --goal-border: #16a085;
            --shadow: 0 4px 15px rgba(0,0,0,0.5);

            /* Stats Modal Dark Theme */
            --modal-bg: #1a1b26;
            --modal-text: #a9b1d6;
            --modal-border: #2f334d;
            --card-bg: #24283b;
            --chart-grid: #2f334d;
            --chart-text: #a9b1d6;
            --close-btn-hover: #ffffff;
        }

        /* FIX: Apply border-box globally to prevent padding from expanding widths */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            background-color: var(--container-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 900px;
            transition: background-color 0.3s;
            margin-bottom: 20px;
        }

        /* --- HEADER --- */
        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 20px;
            padding-bottom: 10px;
        }

        h2 { margin: 0; color: var(--heading-color); font-size: 1.5rem; }
        .report-date { display: none; }

        /* Course Name Input Styling */
        .course-name-input {
            display: block;
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--heading-color);
            background: transparent;
            border: 1px dashed var(--input-border);
            border-width: 0 0 1px 0;
            width: 100%;
            max-width: 400px;
            padding: 5px 0;
            margin-bottom: 5px;
            transition: border-color 0.3s;
        }
        .course-name-input:focus {
            outline: none;
            border-bottom: 2px solid var(--accent-color);
        }
        .course-name-input::placeholder {
            color: var(--text-muted);
            font-weight: normal;
            font-size: 1.5rem;
            font-style: italic;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .theme-toggle, .stats-btn {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-main);
            font-size: 16px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .theme-toggle:hover, .stats-btn:hover { background-color: var(--th-bg); }
        .stats-btn { font-size: 14px; font-weight: 600; }

        /* --- TABLE --- */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        th {
            text-align: left;
            padding: 12px;
            background-color: var(--th-bg);
            color: var(--text-secondary);
            font-weight: 600;
            border-bottom: 2px solid var(--border-color);
        }

        td {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
        }

        /* --- INPUTS --- */
        input[type="text"], input[type="number"], select {
            padding: 8px;
            border: 1px solid var(--input-border);
            background-color: var(--input-bg);
            color: var(--input-text);
            border-radius: 4px;
            width: 100%;
            /* box-sizing: border-box; handled by global rule now */
            font-size: 14px;
        }

        /* Update number inputs to support text (math expressions) */
        input[type="number"] { text-align: right; }
        .num-input { text-align: right; }
        .category-input { width: 200px; }
        .num-input { width: 80px; }
        
        .row-percent {
            font-weight: bold;
            color: var(--percent-text);
            text-align: right;
        }

        /* --- CONTROLS --- */
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-top: 20px;
        }

        .buttons-left { display: flex; gap: 10px; }

        button.btn-std {
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
            color: white;
        }

        button.add-btn { background-color: var(--accent-color); }
        button.add-btn:hover { background-color: var(--accent-hover); }

        button.export-btn { background-color: #27ae60; }
        button.export-btn:hover { background-color: #2ecc71; }
        
        button.email-btn { background-color: #8e44ad; }
        button.email-btn:hover { background-color: #9b59b6; }

        button.clear-btn { background-color: #7f8c8d; }
        button.clear-btn:hover { background-color: #95a5a6; }

        button.delete-btn {
            background-color: var(--delete-btn);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
        }
        button.delete-btn:hover { background-color: var(--delete-hover); }

        /* --- RESULT BOX --- */
        .result-box {
            text-align: right;
            background-color: var(--result-box-bg);
            padding: 15px;
            border-radius: 8px;
            min-width: 200px;
        }

        .result-box div { margin-bottom: 5px; font-size: 14px; color: var(--text-muted); }
        .final-grade { font-size: 24px; font-weight: bold; color: var(--heading-color); }
        .total-weight-warning { color: #e67e22; font-weight: bold; }

        /* --- GOAL CALCULATOR SECTION --- */
        .goal-section {
            margin-top: 30px;
            padding: 20px;
            background-color: var(--goal-box-bg);
            border-left: 5px solid var(--goal-border);
            border-radius: 4px;
        }
        
        .goal-section h3 {
            margin-top: 0;
            color: var(--text-main);
            font-size: 18px;
        }

        .goal-controls {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .goal-input-group {
            display: flex;
            flex-direction: column;
        }
        
        .goal-input-group label {
            font-size: 12px;
            margin-bottom: 5px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        button.calc-goal-btn {
            background-color: var(--goal-border);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            height: 35px;
        }
        button.calc-goal-btn:hover { opacity: 0.9; }

        .goal-result {
            margin-top: 15px;
            font-weight: bold;
            color: var(--text-main);
            font-size: 16px;
        }

        /* --- STATS DASHBOARD MODAL --- */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: var(--modal-bg);
            color: var(--modal-text);
            width: 90%;
            max-width: 1000px;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--modal-border);
            transition: background-color 0.3s, color 0.3s;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            border-bottom: 1px solid var(--modal-border);
            padding-bottom: 15px;
        }

        .modal-header h2 {
            color: var(--modal-text);
            margin: 0;
            font-size: 24px;
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--modal-text);
            opacity: 0.7;
            font-size: 28px;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .close-modal:hover { opacity: 1; color: var(--close-btn-hover); }

        /* Dashboard Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--modal-border);
            transition: background-color 0.3s;
        }

        .stat-card h3 {
            font-size: 32px;
            margin: 0 0 5px 0;
            font-weight: 700;
        }
        .stat-card span {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.7;
        }

        /* Colors for cards matching screenshot vibe */
        .text-green { color: #10b981; }
        .text-orange { color: #f59e0b; }
        .text-purple { color: #8b5cf6; }

        /* Chart Area */
        .chart-container {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--modal-border);
            height: 350px;
            margin-bottom: 30px;
            transition: background-color 0.3s;
        }

        /* History Table */
        .history-table-container {
            background-color: var(--card-bg);
            border-radius: 8px;
            border: 1px solid var(--modal-border);
            padding: 20px;
            transition: background-color 0.3s;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            color: var(--modal-text);
        }

        .history-table th {
            text-align: left;
            padding: 10px;
            border-bottom: 1px solid var(--modal-border);
            color: var(--accent-color);
            font-size: 14px;
        }

        .history-table td {
            padding: 12px 10px;
            border-bottom: 1px solid var(--modal-border);
            font-size: 14px;
        }
        .history-table tr:last-child td { border-bottom: none; }

        .modal-footer {
            margin-top: 20px;
            display: flex;
            justify-content: center;
        }
        
        .modal-close-btn {
            background-color: var(--card-bg);
            color: var(--modal-text);
            border: 1px solid var(--modal-border);
            padding: 10px 30px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .modal-close-btn:hover { background-color: var(--th-bg); }

        /* --- PRINT / PDF EXPORT STYLES --- */
        @media print {
            /* General Print Reset */
            @page {
                margin: 0.75in;
                size: auto;
            }

            .buttons-left, .delete-btn, .header-actions, th:last-child, td:last-child, .stats-btn, .modal-overlay {
                display: none !important;
            }

            /* Only show Goal Section if it has been calculated */
            .goal-section {
                display: none; /* Hidden by default in print */
            }
            .goal-section.goal-calculated {
                display: block !important;
                float: left !important;
                width: 55% !important;
                border: 1px solid #ddd !important;
                border-left: 4px solid #333 !important;
                background-color: #fafafa !important;
                color: #000 !important;
                padding: 15px !important;
                border-radius: 4px !important;
                box-sizing: border-box !important;
                margin-top: 0 !important;
            }
            /* Hide controls inside goal section during print */
            .goal-controls {
                display: none !important;
            }
            
            .goal-section h3 {
                margin-top: 0 !important;
                font-size: 16px !important;
                border-bottom: 1px solid #eee;
                padding-bottom: 8px;
                margin-bottom: 10px;
                color: #333 !important;
            }
            
            .goal-result {
                margin-top: 0 !important;
                color: #000 !important;
                font-size: 14px !important;
                line-height: 1.5 !important;
            }

            body { 
                background-color: white !important; 
                color: #222 !important; 
                padding: 0 !important; 
                margin: 0 !important;
                display: block !important; 
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif !important;
            }
            
            .container { 
                box-shadow: none !important; 
                width: 100% !important;
                max-width: 100% !important; 
                padding: 0 !important;
                border: none !important; 
                margin: 0 !important; 
            }
            
            /* Header Styling */
            .header-row { 
                border-bottom: 3px solid #000 !important; 
                margin-bottom: 25px !important; 
                padding-bottom: 10px !important; 
                display: block !important; 
            }
            
            h2 { display: none !important; } 
            
            .report-date { 
                display: block !important; 
                color: #555 !important; 
                font-size: 14px !important; 
                margin-top: 5px !important;
            }
            
            .course-name-input {
                border: none !important;
                background: transparent !important;
                font-size: 36px !important;
                font-weight: 800 !important;
                color: #000 !important;
                margin-bottom: 0 !important;
                padding: 0 !important;
                width: 100% !important;
            }
            .course-name-input::placeholder {
                color: transparent !important; 
            }
            
            /* Table Styling */
            table { 
                width: 100% !important; 
                border-collapse: collapse !important; 
                margin-bottom: 30px !important; 
            }
            
            th { 
                background-color: #f8f9fa !important; 
                color: #000 !important; 
                border-bottom: 2px solid #000 !important; 
                border-top: 1px solid #ddd !important;
                padding: 12px 8px !important; 
                text-transform: uppercase !important; 
                font-size: 11px !important; 
                font-weight: 700 !important;
                letter-spacing: 0.5px;
            }
            
            td { 
                border-bottom: 1px solid #eee !important; 
                padding: 12px 8px !important; 
                color: #000 !important; 
                font-size: 13px !important;
            }
            
            /* Inputs look like Text */
            input { 
                border: none !important; 
                background: transparent !important; 
                color: #000 !important; 
                padding: 0 !important; 
                font-weight: 500; 
                font-family: inherit !important; 
                font-size: 13px !important; 
            }
            
            /* Alignments */
            td:not(:first-child) input, 
            th:not(:first-child), 
            .row-percent { 
                text-align: right !important; 
            }
            
            /* Footer Layout - Using a cleaner Float approach to ensure compatibility */
            .controls {
                display: block !important; 
                margin-top: 0 !important;
                overflow: hidden; /* Clear floats */
            }
            
            /* Right Side: Result Box */
            .result-box { 
                float: right !important; 
                width: 40% !important; 
                background-color: #fff !important; 
                border: 2px solid #000 !important; 
                color: #000 !important; 
                padding: 20px !important; 
                border-radius: 6px !important;
                box-sizing: border-box !important;
                text-align: right !important;
                margin-right: 0 !important;
            }
            
            .result-box div { 
                color: #555 !important; 
                font-size: 14px !important; 
                margin-bottom: 5px !important;
            }
            
            .final-grade { 
                color: #000 !important; 
                font-size: 36px !important; 
                margin-top: 10px !important; 
                font-weight: 800 !important;
            }
            
            /* Hide chart colors in print if needed, but text is forced black */
            .row-percent { color: #000 !important; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header-row">
        <div>
            <!-- Course Name Input -->
            <input type="text" id="courseNameInput" class="course-name-input" placeholder="Enter Course Name..." oninput="updatePageTitle(this)">
            <h2>Course Grade Report</h2>
            <div class="report-date" id="reportDate"></div>
        </div>
        <div class="header-actions">
            <button class="stats-btn" id="openStatsBtn">üìä Community Stats</button>
            <button class="theme-toggle" id="themeBtn" onclick="toggleTheme()" title="Toggle Dark/Light Mode">‚òÄÔ∏è</button>
        </div>
    </div>
    
    <table id="gradeTable">
        <thead>
            <tr>
                <th>Category Name</th>
                <th>Points Earned</th>
                <th>Total Points</th>
                <th>Current %</th>
                <th>Weight (%)</th>
                <th></th>
            </tr>
        </thead>
        <tbody id="tableBody">
            <!-- Rows injected by JS -->
        </tbody>
    </table>

    <div class="controls">
        <div class="buttons-left">
            <button class="btn-std add-btn" onclick="addRow()">+ Add Category</button>
            <button class="btn-std clear-btn" onclick="clearAll()">Clear</button>
            <button class="btn-std export-btn" id="exportBtn">Export PDF</button>
            <button class="btn-std email-btn" onclick="emailReport()">Email Report</button>
        </div>
        
        <div class="result-box">
            <div id="weightDisplay">Total Weight: 0%</div>
            <div>Final Grade:</div>
            <div class="final-grade" id="finalGrade">0.00%</div>
        </div>
    </div>

    <!-- GOAL CALCULATOR SECTION -->
    <div class="goal-section" id="goalSection">
        <h3>üèÜ Goal Calculator</h3>
        <div class="goal-controls">
            <div class="goal-input-group">
                <label>Target Grade (%)</label>
                <input type="number" id="targetGrade" placeholder="90" style="width: 100px;">
            </div>
            <div class="goal-input-group">
                <label>Calculate For Category</label>
                <select id="goalCategorySelect" onmousedown="updateGoalDropdown()" style="width: 250px;">
                    <option value="">Select a category...</option>
                </select>
            </div>
            <button class="calc-goal-btn" onclick="calculateGoal()">Calculate Needed Score</button>
        </div>
        <div class="goal-result" id="goalResult"></div>
    </div>
</div>

<!-- STATS MODAL DASHBOARD -->
<div class="modal-overlay" id="statsModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Community Statistics</h2>
            <button class="close-modal" onclick="closeStats()">√ó</button>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h3 class="text-green" id="dashGrades">0</h3>
                <span>Grades Calculated</span>
            </div>
            <div class="stat-card">
                <h3 class="text-orange" id="dashPoints">0</h3>
                <span>Total Points</span>
            </div>
            <div class="stat-card">
                <h3 class="text-purple" id="dashExports">0</h3>
                <span>Reports Exported</span>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="statsChart"></canvas>
        </div>

        <div class="history-table-container">
            <h3>History by Month</h3>
            <table class="history-table">
                <thead>
                    <tr>
                        <th>Month</th>
                        <th>Grades Calculated</th>
                        <th>Total Points</th>
                        <th>Reports Exported</th>
                    </tr>
                </thead>
                <tbody id="historyTableBody">
                    <!-- History rows go here -->
                </tbody>
            </table>
        </div>

        <div class="modal-footer">
            <button class="modal-close-btn" onclick="closeStats()">Close</button>
        </div>
    </div>
</div>


<!-- FIREBASE MODULE -->
<script type="module">
    // Import Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, onValue, update, increment, get, child } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAnFiOGWezksnsxJlukAEul6XbCmLYoQno",
        authDomain: "grade-calculator-c4684.firebaseapp.com",
        databaseURL: "https://grade-calculator-c4684-default-rtdb.firebaseio.com",
        projectId: "grade-calculator-c4684",
        storageBucket: "grade-calculator-c4684.firebasestorage.app",
        messagingSenderId: "721967682600",
        appId: "1:721967682600:web:2583b99028f5cd4e19111d"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- HELPER: GET CURRENT MONTH KEY (YYYY-MM) ---
    function getMonthKey() {
        const d = new Date();
        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
    }

    // --- HELPER: CHECK IF LOCALHOST ---
    function isLocalhost() {
        return window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
    }

    // --- WRITE STATS LOGIC ---
    let debounceTimer;
    let sessionMaxCategories = 0; // Track max categories for this session
    let sessionMaxPoints = 0;     // Track max points for this session

    window.recordCalculationStat = function(currentTotalPoints, categoryCount) {
        // Prevent recording on localhost
        if (isLocalhost()) return;

        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            if (currentTotalPoints > 0) {
                const monthKey = getMonthKey();
                const updates = {};
                
                // Calculate unique categories added since last record
                let categoriesToAdd = 0;
                if (categoryCount > sessionMaxCategories) {
                    categoriesToAdd = categoryCount - sessionMaxCategories;
                    sessionMaxCategories = categoryCount;
                }

                // Calculate unique points added since last record
                let pointsToAdd = 0;
                if (currentTotalPoints > sessionMaxPoints) {
                    pointsToAdd = currentTotalPoints - sessionMaxPoints;
                    sessionMaxPoints = currentTotalPoints;
                }

                // Update Global Stats
                updates['stats/global/grades_calculated'] = increment(1);
                
                if (pointsToAdd > 0) {
                    updates['stats/global/total_points'] = increment(pointsToAdd);
                }
                
                if (categoriesToAdd > 0) {
                    updates['stats/global/total_categories'] = increment(categoriesToAdd);
                }
                
                // Update Monthly Stats
                updates[`stats/monthly/${monthKey}/grades_calculated`] = increment(1);
                
                if (pointsToAdd > 0) {
                    updates[`stats/monthly/${monthKey}/total_points`] = increment(pointsToAdd);
                }
                
                if (categoriesToAdd > 0) {
                    updates[`stats/monthly/${monthKey}/total_categories`] = increment(categoriesToAdd);
                }

                update(ref(db), updates);
            }
        }, 3000);
    };

    window.recordExportStat = function() {
        // Always run window.print() first so the user gets their PDF
        window.print();

        // Prevent recording on localhost
        if (isLocalhost()) return;

        const monthKey = getMonthKey();
        const updates = {};
        
        // Update Global
        updates['stats/global/reports_exported'] = increment(1);
        
        // Update Monthly
        updates[`stats/monthly/${monthKey}/reports_exported`] = increment(1);
        
        update(ref(db), updates);
    };

    // --- READ STATS FOR DASHBOARD ---
    window.loadDashboardStats = async function() {
        const dbRef = ref(db);
        try {
            const snapshot = await get(child(dbRef, 'stats'));
            if (snapshot.exists()) {
                const data = snapshot.val();
                const global = data.global || {};
                const monthly = data.monthly || {};

                // 1. Populate Top Cards
                document.getElementById('dashGrades').innerText = (global.grades_calculated || 0).toLocaleString();
                document.getElementById('dashPoints').innerText = (global.total_points || 0).toLocaleString();
                document.getElementById('dashExports').innerText = (global.reports_exported || 0).toLocaleString();

                // 2. Process Monthly Data for Table and Chart
                const months = Object.keys(monthly).sort(); // Sorts YYYY-MM correctly
                const labels = [];
                const gradeData = [];
                const pointsData = []; // New array for points
                const exportData = [];
                const tbody = document.getElementById('historyTableBody');
                tbody.innerHTML = '';

                // Iterate backwards for table (newest first), forwards for chart (oldest first)
                
                // Chart Data (Oldest -> Newest)
                months.forEach(m => {
                    labels.push(m);
                    gradeData.push(monthly[m].grades_calculated || 0);
                    pointsData.push(monthly[m].total_points || 0); // Collect points data
                    exportData.push(monthly[m].reports_exported || 0);
                });

                // Table Data (Newest -> Oldest)
                [...months].reverse().forEach(m => {
                    const row = monthly[m];
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${m}</td>
                        <td class="text-green">${(row.grades_calculated || 0).toLocaleString()}</td>
                        <td class="text-orange">${(row.total_points || 0).toLocaleString()}</td>
                        <td class="text-purple">${(row.reports_exported || 0).toLocaleString()}</td>
                    `;
                    tbody.appendChild(tr);
                });

                // 3. Render Chart with new pointsData
                renderChart(labels, gradeData, exportData, pointsData);
            }
        } catch (error) {
            console.error(error);
        }
    }

    // Bind export button
    document.getElementById('exportBtn').addEventListener('click', window.recordExportStat);
</script>

<script>
    // --- UI LOGIC ---

    document.getElementById('reportDate').innerText = new Date().toLocaleDateString();

    /* --- CHART JS SETUP --- */
    let myChart = null;

    function renderChart(labels, gradeData, exportData, pointsData) {
        const ctx = document.getElementById('statsChart').getContext('2d');
        
        if (myChart) {
            myChart.destroy();
        }

        // Determine Theme Colors
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        const gridColor = isDark ? '#2f334d' : '#e5e5e5';
        const textColor = isDark ? '#a9b1d6' : '#666666';

        // Set global defaults for this chart
        Chart.defaults.color = textColor;
        Chart.defaults.borderColor = gridColor;

        myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Grades Calculated',
                        data: gradeData,
                        backgroundColor: 'rgba(16, 185, 129, 0.7)', // Green
                        borderColor: '#10b981',
                        borderWidth: 1,
                        yAxisID: 'y',
                        order: 2
                    },
                    {
                        label: 'Total Points',
                        data: pointsData,
                        type: 'line',
                        borderColor: '#f59e0b', // Orange
                        backgroundColor: '#f59e0b',
                        tension: 0.4,
                        yAxisID: 'y2', // Separate axis
                        order: 0 // Draw on top
                    },
                    {
                        label: 'Reports Exported',
                        data: exportData,
                        type: 'line',
                        borderColor: '#8b5cf6', // Purple
                        backgroundColor: '#8b5cf6',
                        tension: 0.4,
                        yAxisID: 'y1',
                        order: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: { color: textColor }
                    }
                },
                scales: {
                    x: {
                        ticks: { color: textColor },
                        grid: { color: gridColor }
                    },
                    y: { // Grades Calculated (Left)
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: { display: true, text: 'Grades', color: '#10b981' },
                        ticks: { color: '#10b981' },
                        grid: { color: gridColor }
                    },
                    y1: { // Reports Exported (Right 1)
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: { display: true, text: 'Exports', color: '#8b5cf6' },
                        ticks: { color: '#8b5cf6' },
                        grid: { drawOnChartArea: false }
                    },
                    y2: { // Total Points (Right 2)
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: { display: true, text: 'Points', color: '#f59e0b' },
                        ticks: { color: '#f59e0b' },
                        grid: { drawOnChartArea: false }
                    }
                }
            }
        });
    }

    /* --- MODAL LOGIC --- */
    const modal = document.getElementById('statsModal');
    
    document.getElementById('openStatsBtn').onclick = function() {
        modal.style.display = 'flex';
        // Trigger data load
        if(typeof window.loadDashboardStats === 'function') {
            window.loadDashboardStats();
        }
    };

    window.closeStats = function() {
        modal.style.display = 'none';
    };

    // Close on click outside
    window.onclick = function(event) {
        if (event.target == modal) {
            closeStats();
        }
    };


    /* --- THEME LOGIC --- */
    function initTheme() {
        const savedTheme = localStorage.getItem('theme');
        const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        
        if (savedTheme === 'dark' || (!savedTheme && systemPrefersDark)) {
            document.documentElement.setAttribute('data-theme', 'dark');
            document.getElementById('themeBtn').innerText = 'üåô';
        } else {
            document.documentElement.setAttribute('data-theme', 'light');
            document.getElementById('themeBtn').innerText = '‚òÄÔ∏è';
        }
    }

    function toggleTheme() {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        document.getElementById('themeBtn').innerText = newTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';

        // Re-render chart if modal is open to update colors
        if (modal.style.display === 'flex') {
            if(typeof window.loadDashboardStats === 'function') {
                window.loadDashboardStats();
            }
        }
    }

    /* --- CALCULATOR LOGIC --- */
    const tableBody = document.getElementById('tableBody');
    const finalGradeDisplay = document.getElementById('finalGrade');
    const weightDisplay = document.getElementById('weightDisplay');

    // Helper to evaluate simple math (e.g. "22+5")
    function parseScore(input) {
        if (!input) return 0;
        // Clean string: allow digits, dot, operators +, -, *, /, (, )
        const clean = input.toString().replace(/[^0-9\.\+\-\*\/\(\)]/g, '');
        if (!clean) return 0;
        try {
            // Check if it creates a valid number
            const result = new Function('return ' + clean)();
            return isFinite(result) ? result : 0;
        } catch (e) {
            return 0;
        }
    }

    /* --- INPUT FOCUS/BLUR HANDLERS --- */
    function handleFocus(input) {
        // When clicking in, show the raw formula if it exists (e.g. show "22+25" instead of "47")
        if (input.dataset.raw) {
            input.value = input.dataset.raw;
        }
    }

    function handleBlur(input) {
        // When leaving the box, save the formula and show the calculated result
        const rawValue = input.value;
        input.dataset.raw = rawValue;
        
        // Only calculate if not empty
        if (rawValue.trim() !== "") {
            const result = parseScore(rawValue);
            // Update the display to show the result (e.g. "47")
            // We strip decimals if it's a whole number for cleaner look
            input.value = Number.isInteger(result) ? result : result.toFixed(2);
        }
    }

    function updatePageTitle(input) {
        const val = input.value.trim();
        if (val) {
            document.title = val; // Set the page title which becomes the PDF filename
        } else {
            document.title = "Grade Calculator";
        }
    }

    function initCalculator() {
        addRow();
        addRow();
        addRow();
        calculate();
        updateGoalDropdown();
    }

    function addRow() {
        const row = document.createElement('tr');
        // Inputs are now type="text" to allow formulas like "22+5"
        // Added onfocus and onblur to handle formula view
        row.innerHTML = `
            <td><input type="text" class="category-input" placeholder="Category Name" onchange="updateGoalDropdown()"></td>
            <td><input type="text" class="num-input earned" placeholder="0" oninput="calculate()" onfocus="handleFocus(this)" onblur="handleBlur(this)"></td>
            <td><input type="text" class="num-input max" placeholder="0" oninput="calculate()" onfocus="handleFocus(this)" onblur="handleBlur(this)"></td>
            <td class="row-percent">0.00%</td>
            <td><input type="number" class="num-input weight" placeholder="0" oninput="calculate()"></td>
            <td><button class="delete-btn" onclick="removeRow(this)">√ó</button></td>
        `;
        tableBody.appendChild(row);
    }

    function removeRow(btn) {
        btn.closest('tr').remove();
        calculate();
        updateGoalDropdown();
    }

    function clearAll() {
        if(confirm("Are you sure you want to clear all data?")) {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            document.getElementById('courseNameInput').value = '';
            document.getElementById('targetGrade').value = '';
            document.getElementById('goalResult').innerHTML = '';
            
            // Remove calculated class
            document.getElementById('goalSection').classList.remove('goal-calculated');
            
            updatePageTitle({value: ''}); 
            initCalculator();
        }
    }

    function emailReport() {
        const btn = document.querySelector('.email-btn');
        const originalText = btn.innerText;
        btn.innerText = "Sending...";
        btn.disabled = true;

        const courseName = document.getElementById('courseNameInput').value || "Course Grade Report";
        const finalGrade = document.getElementById('finalGrade').innerText;
        
        let message = `Course: ${courseName}\nFinal Grade: ${finalGrade}\n\nBreakdown:\n`;
        
        const rows = document.querySelectorAll('#tableBody tr');
        rows.forEach(row => {
            const cat = row.querySelector('.category-input').value || "Category";
            const earned = row.querySelector('.earned').value || 0;
            const max = row.querySelector('.max').value || 0;
            const weight = row.querySelector('.weight').value || 0;
            
            message += `- ${cat}: ${earned}/${max} (Weight: ${weight}%)\n`;
        });
        
        // Add Goal Result to email if it exists
        const goalText = document.getElementById('goalResult').innerText;
        if (goalText && goalText.trim().length > 0) {
            // Basic cleanup of newlines/spaces
            const cleanGoal = goalText.replace(/\n+/g, ' ').trim();
            message += `\n\nGoal Analysis:\n${cleanGoal}`;
        }
        
        const subject = encodeURIComponent(`${courseName} - Grade Report`);
        const bodyEnc = encodeURIComponent(message);
        
        window.location.href = `mailto:?subject=${subject}&body=${bodyEnc}`;
        
        btn.innerText = originalText;
        btn.disabled = false;
    }

    function calculate() {
        let totalWeightedScore = 0;
        let totalWeight = 0;
        let totalMaxPointsForStats = 0;
        
        // Stats Logic: Count active vs complete rows
        let activeRows = 0;
        let completeRows = 0;

        const rows = document.querySelectorAll('#tableBody tr');

        rows.forEach(row => {
            const earnedInput = row.querySelector('.earned');
            const maxInput = row.querySelector('.max');
            const weightInput = row.querySelector('.weight');
            
            const eVal = earnedInput.value;
            const mVal = maxInput.value;
            const wVal = weightInput.value;

            // A row is "Active" if user has typed anything in numbers
            // A row is "Complete" if user has typed ALL numbers
            // We ignore rows that are completely blank (e.g. init rows)
            if (eVal !== '' || mVal !== '' || wVal !== '') {
                activeRows++;
                if (eVal !== '' && mVal !== '' && wVal !== '') {
                    completeRows++;
                }
            }

            // Use parseScore to handle both simple numbers and "22+5"
            const earned = parseScore(eVal);
            const max = parseScore(mVal);
            const weight = parseFloat(wVal) || 0;
            const percentDisplay = row.querySelector('.row-percent');

            totalMaxPointsForStats += max;

            if (max > 0) {
                const p = (earned / max) * 100;
                percentDisplay.innerText = p.toFixed(2) + '%';
                totalWeightedScore += (earned / max) * weight;
                totalWeight += weight;
            } else {
                percentDisplay.innerText = 'N/A';
            }
            
            if (weight > 0 && max === 0) {
                totalWeight += weight;
            }
        });

        weightDisplay.innerText = `Total Weight: ${totalWeight}%`;
        
        if (totalWeight !== 100 && totalWeight !== 0) {
            weightDisplay.classList.add('total-weight-warning');
        } else {
            weightDisplay.classList.remove('total-weight-warning');
        }

        finalGradeDisplay.innerText = totalWeightedScore.toFixed(2) + '%';

        // RECORD STATS only if:
        // 1. We have at least one active row (don't record blank tables)
        // 2. All active rows are fully complete (don't record half-finished data)
        const shouldRecord = activeRows > 0 && activeRows === completeRows;
        
        if (typeof window.recordCalculationStat === 'function' && shouldRecord) {
            window.recordCalculationStat(totalMaxPointsForStats, activeRows);
        }
    }

    /* --- GOAL SEEKING LOGIC --- */
    function updateGoalDropdown() {
        const select = document.getElementById('goalCategorySelect');
        const rows = document.querySelectorAll('#tableBody tr');
        const currentVal = select.value;
        select.innerHTML = '<option value="">Select a category...</option>';

        rows.forEach((row, index) => {
            const nameInput = row.querySelector('.category-input').value;
            const label = nameInput.trim() !== "" ? nameInput : `Row ${index + 1}`;
            const option = document.createElement('option');
            option.value = index;
            option.text = label;
            select.appendChild(option);
        });

        select.value = currentVal;
    }

    function calculateGoal() {
        const target = parseFloat(document.getElementById('targetGrade').value);
        const selectedIndex = document.getElementById('goalCategorySelect').value;
        const resultDiv = document.getElementById('goalResult');
        const goalSection = document.getElementById('goalSection');

        if (isNaN(target)) {
            resultDiv.innerHTML = "Please enter a valid target grade percentage.";
            return;
        }
        if (selectedIndex === "") {
            resultDiv.innerHTML = "Please select a category to calculate for.";
            return;
        }

        let sumOfOthers = 0;
        let targetMax = 0;
        let targetWeight = 0;
        let targetName = "";

        const rows = document.querySelectorAll('#tableBody tr');
        
        rows.forEach((row, index) => {
            const earned = parseScore(row.querySelector('.earned').value);
            const max = parseScore(row.querySelector('.max').value);
            const weight = parseFloat(row.querySelector('.weight').value) || 0;

            if (index == selectedIndex) {
                targetMax = max;
                targetWeight = weight;
                targetName = row.querySelector('.category-input').value || "Selected Category";
            } else {
                if (max > 0) {
                    sumOfOthers += (earned / max) * weight;
                }
            }
        });

        if (targetWeight === 0) {
            resultDiv.innerHTML = `Category <strong>${targetName}</strong> has no weight (0%). Please enter a weight first.`;
            return;
        }
        if (targetMax === 0) {
            resultDiv.innerHTML = `Category <strong>${targetName}</strong> has 0 total points. Please enter Max Points first.`;
            return;
        }

        const weightedPointsNeeded = target - sumOfOthers;
        const pointsNeeded = (weightedPointsNeeded / targetWeight) * targetMax;
        const percentageNeeded = (pointsNeeded / targetMax) * 100;

        resultDiv.innerHTML = `
            To get a <strong>${target}%</strong> overall, you need:<br>
            <span style="font-size: 1.2em; color: var(--accent-hover);">
                ${pointsNeeded.toFixed(2)} / ${targetMax} points (${percentageNeeded.toFixed(2)}%)
            </span>
            <br>on <em>${targetName}</em>.
        `;
        
        // Add class to show section in PDF
        goalSection.classList.add('goal-calculated');
    }

    initTheme();
    initCalculator();

</script>

</body>
</html>