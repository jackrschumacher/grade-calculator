<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Grade Calculator</title>
    <!-- Favicon -->
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    
    <!-- Chart.js for the Dashboard -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- html2canvas for Image Export -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- CSS VARIABLES (THEMING) --- */
        :root {
            --bg-color: #f4f6f8;
            --container-bg: #ffffff;
            --text-main: #2c3e50;
            --text-secondary: #636e72;
            --text-muted: #b2bec3;
            --border-color: #dfe6e9;
            
            --accent-color: #3498db;
            --accent-hover: #2980b9;
            
            --mint-primary: #1abc9c;
            --mint-bg: #e8f6f3;
            --mint-hover: #16a085;
            
            --delete-btn: #e74c3c;
            --delete-hover: #c0392b;
            
            --result-bg: #ecf0f1;
            
            --shadow: 0 2px 10px rgba(0,0,0,0.05);

            /* Modal Styling */
            --modal-bg: #ffffff;
            --modal-text: #333333;
            --modal-border: #e0e0e0;
            --card-bg: #f8f9fa;
            --close-btn-hover: #333333;
        }

        [data-theme="dark"] {
            --bg-color: #121212;
            --container-bg: #1e1e1e;
            --text-main: #e0e0e0;
            --text-secondary: #b0b0b0;
            --text-muted: #636e72;
            --border-color: #333333;
            
            --accent-color: #3498db;
            --accent-hover: #5dade2;
            
            --mint-primary: #1abc9c;
            --mint-bg: #1a3a34;
            --mint-hover: #16a085;
            
            --delete-btn: #cf6679;
            --delete-hover: #b00020;
            
            --result-bg: #2d2d2d;
            
            --shadow: 0 4px 15px rgba(0,0,0,0.5);

            /* Modal Styling Dark */
            --modal-bg: #1a1b26;
            --modal-text: #a9b1d6;
            --modal-border: #2f334d;
            --card-bg: #24283b;
            --close-btn-hover: #ffffff;
        }

        /* FIX: Apply border-box globally */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 40px 20px;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            background-color: var(--container-bg);
            padding: 40px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 1200px; 
            transition: background-color 0.3s;
            margin-bottom: 20px;
            position: relative;
        }

        /* --- HEADER --- */
        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 30px;
        }

        h2 { 
            margin: 10px 0 0 0; 
            color: var(--text-main); 
            font-size: 1.8rem; 
            font-weight: 700;
        }
        .report-date { display: none; }

        /* Course Name Input Styling */
        .course-name-input {
            display: block;
            font-size: 1.1rem;
            color: var(--text-secondary);
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            width: 100%;
            max-width: 300px;
            padding: 8px 12px;
            margin-bottom: 5px;
            transition: border-color 0.3s;
        }
        .course-name-input:focus {
            outline: none;
            border-color: var(--accent-color);
        }
        .course-name-input::placeholder {
            color: var(--text-muted);
            font-style: italic;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .theme-toggle, .stats-btn {
            background: var(--container-bg);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 6px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .theme-toggle:hover, .stats-btn:hover { background-color: var(--bg-color); }

        /* --- TABLE --- */
        .table-wrapper {
            width: 100%;
            overflow-x: auto;
            margin-bottom: 30px;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 10px; /* Spacing between rows */
            min-width: 600px;
        }

        th {
            text-align: left;
            padding: 0 10px 10px 10px;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.9rem;
            border-bottom: none;
        }

        td {
            padding: 0 5px;
            vertical-align: middle;
        }

        /* --- INPUTS --- */
        input[type="text"], input[type="number"], select {
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            background-color: var(--container-bg);
            color: var(--text-main);
            border-radius: 6px;
            width: 100%;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        input:focus, select:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        input[type="number"] { text-align: right; }
        .num-input { text-align: right; }
        .category-input { width: 100%; } 
        
        .row-percent {
            font-weight: 700;
            color: var(--accent-color);
            text-align: right;
            padding-right: 15px;
        }

        /* --- BUTTONS --- */
        .buttons-row { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        button.btn-std {
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: opacity 0.2s;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        button.btn-std:hover { opacity: 0.9; }

        button.add-btn { background-color: var(--accent-color); }
        button.share-btn { background-color: #27ae60; }
        button.clear-btn { background-color: #95a5a6; }

        button.delete-btn {
            background-color: var(--delete-btn);
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: background-color 0.2s;
        }
        button.delete-btn:hover { background-color: var(--delete-hover); }

        /* --- FOOTER SECTION (Goal & Results) --- */
        .footer-row {
            display: flex;
            gap: 30px;
            align-items: stretch; /* Stretch to same height */
            margin-top: 20px;
        }

        /* --- RESULT BOX (Bottom Right) --- */
        .result-box-wrapper {
            flex: 0 0 320px; /* Fixed width for consistent result look */
        }

        .result-box {
            background-color: var(--result-bg);
            padding: 25px;
            border-radius: 8px;
            text-align: right;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .result-header {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .final-grade { 
            font-size: 32px; 
            font-weight: 800; 
            color: var(--text-main); 
            margin-bottom: 15px;
        }

        .gpa-row {
            display: flex;
            justify-content: space-between;
            padding-top: 15px;
            border-top: 2px solid rgba(0,0,0,0.05);
        }
        .mini-stat { text-align: center; flex: 1; }
        .mini-stat span { display: block; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-secondary); margin-bottom: 4px; }
        .mini-stat div { font-size: 20px; font-weight: 700; color: var(--accent-color); }

        /* --- GOAL CALCULATOR SECTION (Bottom Left) --- */
        .goal-section-wrapper {
            flex: 1; /* Takes remaining space */
        }

        .goal-section {
            padding: 25px;
            background-color: var(--mint-bg);
            border-left: 6px solid var(--mint-primary);
            border-radius: 4px;
            height: 100%;
        }
        
        .goal-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .goal-section h3 { 
            margin: 0; 
            color: var(--text-main); 
            font-size: 18px; 
            font-weight: 700;
        }

        .goal-controls { 
            display: flex; 
            gap: 15px; 
            align-items: flex-end; 
            flex-wrap: wrap; 
        }

        .goal-input-group { 
            display: flex; 
            flex-direction: column; 
            flex: 1;
            min-width: 120px;
        }
        
        .goal-input-group label { 
            font-size: 12px; 
            margin-bottom: 6px; 
            color: var(--text-secondary); 
            font-weight: 600; 
        }

        .goal-section input, .goal-section select {
            background-color: var(--container-bg);
            border: 1px solid rgba(0,0,0,0.1);
        }

        button.calc-goal-btn { 
            background-color: var(--mint-primary); 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 4px; 
            cursor: pointer; 
            font-weight: 600; 
            height: 42px; 
            transition: background 0.2s;
        }
        button.calc-goal-btn:hover { background-color: var(--mint-hover); }

        .goal-result { 
            margin-top: 20px; 
            font-size: 16px; 
            color: var(--text-main);
            padding-top: 15px;
            border-top: 1px solid rgba(0,0,0,0.05);
        }

        /* --- EXPORT MENU MODAL --- */
        .export-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .export-option {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        .export-option:hover { transform: translateY(-2px); border-color: var(--accent-color); }
        .export-icon { font-size: 24px; margin-bottom: 5px; }
        .export-label { font-weight: 600; font-size: 14px; }

        /* --- STATS DASHBOARD MODAL --- */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-content { background-color: var(--modal-bg); color: var(--modal-text); width: 90%; max-width: 1000px; border-radius: 12px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); position: relative; max-height: 90vh; overflow-y: auto; border: 1px solid var(--modal-border); transition: background-color 0.3s, color 0.3s; }
        .modal-content.small-modal { max-width: 500px; }
        
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 1px solid var(--modal-border); padding-bottom: 15px; }
        .modal-header h2 { color: var(--modal-text); margin: 0; font-size: 24px; }
        .close-modal { background: none; border: none; color: var(--modal-text); opacity: 0.7; font-size: 28px; cursor: pointer; transition: opacity 0.2s; }
        .close-modal:hover { opacity: 1; color: var(--close-btn-hover); }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background-color: var(--card-bg); padding: 20px; border-radius: 8px; text-align: center; border: 1px solid var(--modal-border); transition: background-color 0.3s; }
        .stat-card h3 { font-size: 32px; margin: 0 0 5px 0; font-weight: 700; }
        .stat-card span { font-size: 12px; text-transform: uppercase; letter-spacing: 1px; opacity: 0.7; }
        
        .text-green { color: #10b981; } .text-orange { color: #f59e0b; } .text-purple { color: #8b5cf6; } .text-blue { color: #3498db; }
        .chart-container { background-color: var(--card-bg); padding: 20px; border-radius: 8px; border: 1px solid var(--modal-border); height: 350px; margin-bottom: 30px; transition: background-color 0.3s; }
        .history-table-container { background-color: var(--card-bg); border-radius: 8px; border: 1px solid var(--modal-border); padding: 20px; transition: background-color 0.3s; }
        .history-table { width: 100%; border-collapse: collapse; color: var(--modal-text); }
        .history-table th { text-align: left; padding: 10px; border-bottom: 1px solid var(--modal-border); color: var(--accent-color); font-size: 14px; }
        .history-table td { padding: 12px 10px; border-bottom: 1px solid var(--modal-border); font-size: 14px; }
        .history-table tr:last-child td { border-bottom: none; }
        .modal-footer { margin-top: 20px; display: flex; justify-content: center; }
        .modal-close-btn { background-color: var(--card-bg); color: var(--modal-text); border: 1px solid var(--modal-border); padding: 10px 30px; border-radius: 6px; cursor: pointer; transition: background-color 0.2s; }
        .modal-close-btn:hover { background-color: var(--th-bg); }

        /* --- MOBILE LAYOUT OPTIMIZATIONS --- */
        @media (max-width: 768px) {
            body { padding: 15px; }
            .container { padding: 20px; }
            .header-row { flex-direction: column; gap: 15px; }
            .header-actions { width: 100%; justify-content: space-between; }
            .course-name-input { font-size: 1.5rem; max-width: 100%; }

            .footer-row { 
                flex-direction: column-reverse; /* Result box on top of Goal on Mobile */
                gap: 30px; 
            }
            .result-box-wrapper { flex: auto; width: 100%; }
            .goal-section-wrapper { flex: auto; width: 100%; }
            
            .result-box { text-align: center; }
            .gpa-row { justify-content: center; gap: 40px; }
            .final-grade { font-size: 2rem; }

            .buttons-row { display: grid; grid-template-columns: 1fr 1fr; }
            .buttons-row button:last-child { grid-column: span 2; } /* Share button full width */

            .goal-controls { flex-direction: column; align-items: stretch; }
            .goal-input-group { width: 100%; }
            .calc-goal-btn { margin-top: 10px; }
            input, select, textarea { font-size: 16px !important; }
            
            /* Switch Table to Cards */
            thead { display: none; }
            table, tbody, tr, td { display: block; width: 100%; }
            tr {
                margin-bottom: 20px;
                background: var(--container-bg);
                border: 1px solid var(--border-color);
                border-radius: 8px;
                padding: 20px;
                box-shadow: 0 4px 10px rgba(0,0,0,0.03);
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }
            td:nth-of-type(1) { grid-column: 1 / -1; padding: 0; }
            td:nth-of-type(2) { padding: 0; }
            td:nth-of-type(3) { padding: 0; }
            td:nth-of-type(5) { padding: 0; }
            td:nth-of-type(4) { padding: 0; display: flex; align-items: center; justify-content: flex-end; }
            td:nth-of-type(6) { grid-column: 1 / -1; padding: 0; margin-top: 10px; }
            td:nth-of-type(2)::before { content: "Points Earned"; display: block; font-size: 11px; color: var(--text-secondary); margin-bottom: 4px; font-weight: 600; }
            td:nth-of-type(3)::before { content: "Total Points"; display: block; font-size: 11px; color: var(--text-secondary); margin-bottom: 4px; font-weight: 600; }
            td:nth-of-type(5)::before { content: "Weight (%)"; display: block; font-size: 11px; color: var(--text-secondary); margin-bottom: 4px; font-weight: 600; }
            td:nth-of-type(1)::before { content: "Category Name"; display: block; font-size: 11px; color: var(--text-secondary); margin-bottom: 4px; font-weight: 600; }
            .delete-btn { width: 100%; padding: 10px; }
        }

        /* --- PRINT / PDF EXPORT STYLES --- */
        @media print {
            /* General Print Reset */
            @page {
                margin: 0.75in;
                size: auto;
            }

            .buttons-left, .delete-btn, .header-actions, .buttons-row, .modal-overlay, .stats-btn { display: none !important; }

            /* Only show Goal Section if it has been calculated */
            .goal-section {
                display: none; /* Hidden by default in print */
            }
            .goal-section.goal-calculated {
                display: block !important;
                float: left !important;
                width: 55% !important;
                border: 1px solid #ddd !important;
                border-left: 4px solid #333 !important;
                background-color: #fafafa !important;
                color: #000 !important;
                padding: 15px !important;
                border-radius: 4px !important;
                box-sizing: border-box !important;
                margin-top: 0 !important;
                clear: none !important;
            }
            /* Hide controls inside goal section during print */
            .goal-controls {
                display: none !important;
            }
            
            .goal-section h3 {
                margin-top: 0 !important;
                font-size: 16px !important;
                border-bottom: 1px solid #eee;
                padding-bottom: 8px;
                margin-bottom: 10px;
                color: #333 !important;
            }
            
            .goal-result {
                margin-top: 0 !important;
                color: #000 !important;
                font-size: 14px !important;
                line-height: 1.5 !important;
            }

            body { 
                background-color: white !important; 
                color: #222 !important; 
                padding: 0 !important; 
                margin: 0 !important;
                display: block !important; 
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif !important;
            }
            
            .container { 
                box-shadow: none !important; 
                width: 100% !important;
                max-width: 100% !important; 
                padding: 0 !important;
                border: none !important; 
                margin: 0 !important; 
            }
            
            /* Header Styling */
            .header-row { 
                border-bottom: 3px solid #000 !important; 
                margin-bottom: 25px !important; 
                padding-bottom: 10px !important; 
                display: block !important; 
            }
            
            h2 { display: none !important; } 
            
            .report-date { 
                display: block !important; 
                color: #555 !important; 
                font-size: 14px !important; 
                margin-top: 5px !important;
            }
            
            .course-name-input {
                border: none !important;
                background: transparent !important;
                font-size: 28px !important;
                font-weight: bold !important;
                color: black !important;
                margin-bottom: 10px !important;
                padding: 0 !important;
                width: 100% !important;
            }
            .course-name-input::placeholder {
                color: transparent !important; 
            }
            
            /* Table Styling */
            table { width: 100% !important; border-collapse: collapse !important; border-spacing: 0 !important; margin-bottom: 30px !important; }
            th { background-color: #f8f9fa !important; color: #000 !important; border-bottom: 2px solid #000 !important; border-top: 1px solid #ddd !important; padding: 12px 8px !important; text-transform: uppercase !important; font-size: 11px !important; font-weight: 700 !important; letter-spacing: 0.5px; }
            td { border-bottom: 1px solid #ddd; padding: 10px 8px; color: #000 !important; }
            input { border: none; background: transparent; padding: 0; font-weight: 500; color: #000; }
            .row-percent { color: #000 !important; }

            /* Two Column Footer for Print */
            .footer-row { display: flex !important; flex-direction: row !important; gap: 30px !important; }
            
            /* Goal Section Wrapper */
            .goal-section-wrapper { 
                flex: 1.2 !important; 
                display: none; /* Hide wrapper by default */
            }
            /* Only show wrapper if class is present */
            .goal-section-wrapper.visible-in-export { 
                display: block !important; 
            }

            .goal-section { 
                border: 1px solid #ccc !important; 
                border-left: 6px solid #333 !important; 
                background: #f9f9f9 !important; 
                color: #000 !important; 
                padding: 15px !important; 
                height: auto !important;
            }
            .goal-controls { display: none !important; }
            .goal-header { margin-bottom: 10px; }
            .goal-result { margin-top: 0; border-top: none; padding-top: 0; font-size: 14px; color: #000; }

            /* Result Box (Right) */
            .result-box-wrapper { flex: 0 0 300px !important; }
            .result-box { 
                background: white !important; 
                border: 2px solid #000 !important; 
                color: #000 !important; 
                padding: 15px !important; 
                height: auto !important;
            }
            .final-grade { color: #000; font-size: 28px; margin-bottom: 5px; }
            .gpa-row { border-top: 1px solid #000; padding-top: 10px; }
            .mini-stat div { color: #000; }
        }
    </style>
</head>
<body>

<div class="container" id="mainAppContainer">
    <div class="header-row">
        <div>
            <!-- Course Name Input -->
            <input type="text" id="courseNameInput" class="course-name-input" placeholder="Enter Course Name" oninput="updatePageTitle(this); saveData()">
            <h2>Course Grade Report</h2>
            <div class="report-date" id="reportDate"></div>
        </div>
        <div class="header-actions">
            <button class="stats-btn" id="openStatsBtn">üìä Community Stats</button>
            <button class="theme-toggle" id="themeBtn" onclick="toggleTheme()" title="Toggle Dark/Light Mode">‚òÄÔ∏è</button>
        </div>
    </div>
    
    <div class="table-wrapper">
        <table id="gradeTable">
            <thead>
                <tr>
                    <th>CATEGORY NAME</th>
                    <th>POINTS EARNED</th>
                    <th>TOTAL POINTS</th>
                    <th style="text-align: right;">CURRENT %</th>
                    <th style="text-align: right;">WEIGHT (%)</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <!-- Rows injected by JS -->
            </tbody>
        </table>
    </div>

    <div class="buttons-row">
        <button class="btn-std add-btn" onclick="addRow()">+ Add Category</button>
        <button class="btn-std clear-btn" onclick="clearAll()">Clear</button>
        <button class="btn-std share-btn" onclick="openShareModal()">üì§ Share / Export</button>
    </div>
    
    <!-- FOOTER ROW (Goal Left, Result Right) -->
    <div class="footer-row">
        <!-- GOAL CALCULATOR (Left) -->
        <div class="goal-section-wrapper" id="goalSectionWrapper">
            <div class="goal-section" id="goalSection">
                <div class="goal-header">
                    <h3>üèÜ Goal Calculator</h3>
                </div>
                <div class="goal-controls">
                    <div class="goal-input-group">
                        <label>Target Grade (%)</label>
                        <input type="number" id="targetGrade" placeholder="90" oninput="saveData()">
                    </div>
                    <div class="goal-input-group">
                        <label>Calculate For Category</label>
                        <select id="goalCategorySelect" onmousedown="updateGoalDropdown()">
                            <option value="">Select a category...</option>
                        </select>
                    </div>
                    <button class="calc-goal-btn" onclick="calculateGoal()">Calculate Needed Score</button>
                </div>
                <div class="goal-result" id="goalResult"></div>
            </div>
        </div>

        <!-- RESULT BOX (Right) -->
        <div class="result-box-wrapper">
            <div class="result-box">
                <div id="weightDisplay" class="result-header">Total Weight: 0%</div>
                <div class="result-header">Final Grade:</div>
                <div class="final-grade" id="finalGrade">0.00%</div>
                
                <div class="gpa-row">
                    <div class="mini-stat">
                        <span>GPA</span>
                        <div id="finalGPA">0.0</div>
                    </div>
                    <div class="mini-stat">
                        <span>LETTER</span>
                        <div id="finalLetter">F</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- SHARE MENU MODAL -->
<div class="modal-overlay" id="shareModal">
    <div class="modal-content small-modal">
        <div class="modal-header">
            <h2>Share / Export</h2>
            <button class="close-modal" onclick="closeShareModal()">√ó</button>
        </div>
        
        <div class="export-grid">
            <div class="export-option" onclick="window.recordExportStat()">
                <div class="export-icon">üìÑ</div>
                <div class="export-label">Save as PDF</div>
            </div>
            <div class="export-option" onclick="emailReport()">
                <div class="export-icon">üìß</div>
                <div class="export-label">Email Report</div>
            </div>
            <div class="export-option" onclick="copyToClipboard()">
                <div class="export-icon">üìã</div>
                <div class="export-label">Copy Text</div>
            </div>
            <div class="export-option" onclick="downloadImage()">
                <div class="export-icon">üñºÔ∏è</div>
                <div class="export-label">Save Image</div>
            </div>
            <div class="export-option" onclick="downloadCSV()">
                <div class="export-icon">üìä</div>
                <div class="export-label">Download CSV</div>
            </div>
        </div>

        <div class="modal-footer">
            <button class="modal-close-btn" onclick="closeShareModal()">Cancel</button>
        </div>
    </div>
</div>

<!-- STATS MODAL DASHBOARD -->
<div class="modal-overlay" id="statsModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Community Statistics</h2>
            <button class="close-modal" onclick="closeStats()">√ó</button>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h3 class="text-green" id="dashGrades">0</h3>
                <span>Grades Calculated</span>
            </div>
            <div class="stat-card">
                <h3 class="text-orange" id="dashPoints">0</h3>
                <span>Total Points</span>
            </div>
            <div class="stat-card">
                <h3 class="text-purple" id="dashExports">0</h3>
                <span>Reports Exported</span>
            </div>
            <div class="stat-card">
                <h3 class="text-blue" id="dashAvgGrade">-</h3>
                <span>Average Grade</span>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="statsChart"></canvas>
        </div>

        <div class="history-table-container">
            <h3>History by Month</h3>
            <table class="history-table">
                <thead>
                    <tr>
                        <th>Month</th>
                        <th>Grades Calculated</th>
                        <th>Total Points</th>
                        <th>Reports Exported</th>
                    </tr>
                </thead>
                <tbody id="historyTableBody"></tbody>
            </table>
        </div>

        <div class="modal-footer">
            <button class="modal-close-btn" onclick="closeStats()">Close</button>
        </div>
    </div>
</div>


<!-- FIREBASE MODULE -->
<script type="module">
    // Import Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, onValue, update, increment, get, child } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAnFiOGWezksnsxJlukAEul6XbCmLYoQno",
        authDomain: "grade-calculator-c4684.firebaseapp.com",
        databaseURL: "https://grade-calculator-c4684-default-rtdb.firebaseio.com",
        projectId: "grade-calculator-c4684",
        storageBucket: "grade-calculator-c4684.firebasestorage.app",
        messagingSenderId: "721967682600",
        appId: "1:721967682600:web:2583b99028f5cd4e19111d"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    function getMonthKey() {
        const d = new Date();
        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
    }

    function isLocalhost() {
        return window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
    }

    let debounceTimer;
    let sessionMaxCategories = 0; 
    let sessionMaxPoints = 0;

    window.recordCalculationStat = function(currentTotalPoints, categoryCount, currentGPA) {
        // Debug mode: allow localhost, log attempts
        // if (isLocalhost()) return; // COMMENTED OUT FOR DEBUGGING

        console.log("üìù Attempting to record stats...", {currentTotalPoints, categoryCount, currentGPA});

        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            if (currentTotalPoints > 0) {
                const monthKey = getMonthKey();
                const updates = {};
                
                let categoriesToAdd = 0;
                if (categoryCount > sessionMaxCategories) {
                    categoriesToAdd = categoryCount - sessionMaxCategories;
                    sessionMaxCategories = categoryCount;
                }

                let pointsToAdd = 0;
                if (currentTotalPoints > sessionMaxPoints) {
                    pointsToAdd = currentTotalPoints - sessionMaxPoints;
                    sessionMaxPoints = currentTotalPoints;
                }

                updates['stats/global/grades_calculated'] = increment(1);
                // Safety check for NaN to prevent write failures
                if (!isNaN(currentGPA) && currentGPA >= 0) updates['stats/global/total_gpa_sum'] = increment(currentGPA);
                if (pointsToAdd > 0) updates['stats/global/total_points'] = increment(pointsToAdd);
                if (categoriesToAdd > 0) updates['stats/global/total_categories'] = increment(categoriesToAdd);
                
                updates[`stats/monthly/${monthKey}/grades_calculated`] = increment(1);
                if (!isNaN(currentGPA) && currentGPA >= 0) updates[`stats/monthly/${monthKey}/total_gpa_sum`] = increment(currentGPA);
                if (pointsToAdd > 0) updates[`stats/monthly/${monthKey}/total_points`] = increment(pointsToAdd);
                if (categoriesToAdd > 0) updates[`stats/monthly/${monthKey}/total_categories`] = increment(categoriesToAdd);

                update(ref(db), updates);
            }
        }, 1000); // Shortened to 1s for easier testing
    };

    // Updated window.trackExport function for export tracking
    window.trackExport = function() {
        // if (isLocalhost()) return; // Uncomment if you want to block localhost exports
        const monthKey = getMonthKey();
        const updates = {};
        
        updates['stats/global/reports_exported'] = increment(1);
        updates[`stats/monthly/${monthKey}/reports_exported`] = increment(1);
        
        update(ref(db), updates)
        .then(() => console.log("‚úÖ Export stat saved!"))
        .catch((error) => console.error("‚ùå Export Error:", error));
    };

    window.recordExportStat = function() {
        window.print();
        window.trackExport(); // Call the tracking helper
    };

    function getLetterFromGPA(gpa) {
        if (gpa >= 4.0) return 'A'; if (gpa >= 3.7) return 'A-'; if (gpa >= 3.3) return 'B+';
        if (gpa >= 3.0) return 'B'; if (gpa >= 2.7) return 'B-'; if (gpa >= 2.3) return 'C+';
        if (gpa >= 2.0) return 'C'; if (gpa >= 1.7) return 'C-'; if (gpa >= 1.3) return 'D+';
        if (gpa >= 1.0) return 'D'; if (gpa >= 0.7) return 'D-'; return 'F';
    }

    window.loadDashboardStats = async function() {
        const dbRef = ref(db);
        try {
            const snapshot = await get(child(dbRef, 'stats'));
            if (snapshot.exists()) {
                const data = snapshot.val();
                const global = data.global || {};
                const monthly = data.monthly || {};

                document.getElementById('dashGrades').innerText = (global.grades_calculated || 0).toLocaleString();
                document.getElementById('dashPoints').innerText = (global.total_points || 0).toLocaleString();
                document.getElementById('dashExports').innerText = (global.reports_exported || 0).toLocaleString();

                if (global.grades_calculated > 0 && global.total_gpa_sum > 0) {
                    const avgGpa = global.total_gpa_sum / global.grades_calculated;
                    const letter = getLetterFromGPA(avgGpa);
                    document.getElementById('dashAvgGrade').innerText = `${letter} (${avgGpa.toFixed(2)})`;
                } else {
                    document.getElementById('dashAvgGrade').innerText = "N/A";
                }

                const months = Object.keys(monthly).sort();
                const labels = [], gradeData = [], pointsData = [], exportData = [];
                const tbody = document.getElementById('historyTableBody');
                tbody.innerHTML = '';

                months.forEach(m => {
                    labels.push(m);
                    gradeData.push(monthly[m].grades_calculated || 0);
                    pointsData.push(monthly[m].total_points || 0);
                    exportData.push(monthly[m].reports_exported || 0);
                });

                [...months].reverse().forEach(m => {
                    const row = monthly[m];
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${m}</td><td class="text-green">${(row.grades_calculated||0).toLocaleString()}</td><td class="text-orange">${(row.total_points||0).toLocaleString()}</td><td class="text-purple">${(row.reports_exported||0).toLocaleString()}</td>`;
                    tbody.appendChild(tr);
                });

                renderChart(labels, gradeData, exportData, pointsData);
            }
        } catch (error) { console.error(error); }
    }
</script>

<script>
    // --- UI LOGIC ---
    document.getElementById('reportDate').innerText = new Date().toLocaleDateString();

    /* --- CHART JS SETUP --- */
    let myChart = null;
    function renderChart(labels, gradeData, exportData, pointsData) {
        const ctx = document.getElementById('statsChart').getContext('2d');
        if (myChart) myChart.destroy();
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        const gridColor = isDark ? '#2f334d' : '#e5e5e5';
        const textColor = isDark ? '#a9b1d6' : '#666666';
        Chart.defaults.color = textColor;
        Chart.defaults.borderColor = gridColor;

        myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    { label: 'Grades Calculated', data: gradeData, backgroundColor: 'rgba(16, 185, 129, 0.7)', borderColor: '#10b981', borderWidth: 1, yAxisID: 'y', order: 2 },
                    { label: 'Total Points', data: pointsData, type: 'line', borderColor: '#f59e0b', backgroundColor: '#f59e0b', tension: 0.4, yAxisID: 'y2', order: 0 },
                    { label: 'Reports Exported', data: exportData, type: 'line', borderColor: '#8b5cf6', backgroundColor: '#8b5cf6', tension: 0.4, yAxisID: 'y1', order: 1 }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
                plugins: { legend: { position: 'top', labels: { color: textColor } } },
                scales: {
                    x: { ticks: { color: textColor }, grid: { color: gridColor } },
                    y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Grades', color: '#10b981' }, ticks: { color: '#10b981' }, grid: { color: gridColor } },
                    y1: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'Exports', color: '#8b5cf6' }, ticks: { color: '#8b5cf6' }, grid: { drawOnChartArea: false } },
                    y2: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'Points', color: '#f59e0b' }, ticks: { color: '#f59e0b' }, grid: { drawOnChartArea: false } }
                }
            }
        });
    }

    /* --- MODAL LOGIC (Stats & Share) --- */
    const statsModal = document.getElementById('statsModal');
    const shareModal = document.getElementById('shareModal');
    
    document.getElementById('openStatsBtn').onclick = function() {
        statsModal.style.display = 'flex';
        if(typeof window.loadDashboardStats === 'function') window.loadDashboardStats();
    };
    function closeStats() { statsModal.style.display = 'none'; }

    function openShareModal() { shareModal.style.display = 'flex'; }
    function closeShareModal() { shareModal.style.display = 'none'; }

    window.onclick = function(event) {
        if (event.target == statsModal) closeStats();
        if (event.target == shareModal) closeShareModal();
    };

    /* --- NEW EXPORT FUNCTIONS --- */
    
    function getSummaryText() {
        const courseName = document.getElementById('courseNameInput').value || "Course Grade Report";
        const finalGrade = document.getElementById('finalGrade').innerText;
        let text = `Course: ${courseName}\nFinal Grade: ${finalGrade}\n\n`;
        
        const rows = document.querySelectorAll('#tableBody tr');
        rows.forEach(row => {
            const cat = row.querySelector('.category-input').value || "Category";
            const earned = row.querySelector('.earned').value || 0;
            const max = row.querySelector('.max').value || 0;
            const weight = row.querySelector('.weight').value || 0;
            if(cat && max) {
               text += `- ${cat}: ${earned}/${max} (Weight: ${weight}%)\n`;
            }
        });
        
        const goalText = document.getElementById('goalResult').innerText;
        if (goalText && goalText.trim().length > 0) {
            const cleanGoal = goalText.replace(/\n+/g, ' ').trim();
            text += `\nGoal Analysis: ${cleanGoal}`;
        }
        return text;
    }

    function copyToClipboard() {
        if(window.trackExport) window.trackExport(); // Track export
        const text = getSummaryText();
        navigator.clipboard.writeText(text).then(() => {
            alert("Report copied to clipboard!");
            closeShareModal();
        });
    }

    function emailReport() {
        if(window.trackExport) window.trackExport(); // Track export
        const text = getSummaryText();
        const courseName = document.getElementById('courseNameInput').value || "Course Grade Report";
        const subject = encodeURIComponent(`${courseName} - Grade Report`);
        const bodyEnc = encodeURIComponent(text);
        window.location.href = `mailto:?subject=${subject}&body=${bodyEnc}`;
        closeShareModal();
    }

    function downloadCSV() {
        if(window.trackExport) window.trackExport(); // Track export
        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "Category Name,Points Earned,Total Points,Weight (%)\n";
        
        const rows = document.querySelectorAll('#tableBody tr');
        rows.forEach(row => {
            const cat = row.querySelector('.category-input').value || "";
            const earned = row.querySelector('.earned').value || 0;
            const max = row.querySelector('.max').value || 0;
            const weight = row.querySelector('.weight').value || 0;
            const safeCat = cat.includes(',') ? `"${cat}"` : cat;
            if(max) csvContent += `${safeCat},${earned},${max},${weight}\n`;
        });
        
        csvContent += `\nFinal Grade,,${document.getElementById('finalGrade').innerText},`;

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        const name = document.getElementById('courseNameInput').value || "grade_report";
        link.setAttribute("download", `${name}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        closeShareModal();
    }

    function downloadImage() {
        if(window.trackExport) window.trackExport(); // Track export
        const originalContainer = document.getElementById('mainAppContainer');
        const clone = originalContainer.cloneNode(true);
        
        // 1. Setup Clone Container (Fixed Desktop Width)
        clone.style.width = '1000px'; 
        clone.style.position = 'absolute';
        clone.style.left = '-9999px';
        clone.style.top = '0';
        clone.style.backgroundColor = '#ffffff'; 
        clone.style.color = '#2c3e50'; // Force dark text
        clone.style.padding = '60px'; // Generous padding for professional look
        clone.classList.remove('container'); 

        // 2. Remove Interactive Elements
        const buttons = clone.querySelector('.buttons-row');
        if(buttons) buttons.remove();
        
        const themeToggle = clone.querySelector('.header-actions');
        if(themeToggle) themeToggle.remove();
        
        // 3. Goal Section Logic
        const goalWrapper = clone.querySelector('#goalSectionWrapper');
        if (!goalWrapper.classList.contains('visible-in-export')) {
            // If goal calc wasn't used, remove it completely
            goalWrapper.remove();
            
            // Fix layout: If goal is gone, expand result box or align right
            const footer = clone.querySelector('.footer-row');
            if(footer) {
                footer.style.justifyContent = 'flex-end';
                const resultBoxWrapper = clone.querySelector('.result-box-wrapper');
                if(resultBoxWrapper) resultBoxWrapper.style.flex = '0 0 400px'; // Slightly wider result box
            }
        } else {
            // If goal IS used, just remove the inputs/buttons inside it
            const goalControls = clone.querySelector('.goal-controls');
            if(goalControls) goalControls.remove();
            
            // Ensure styling is correct for static view
            const goalSection = clone.querySelector('#goalSection');
            goalSection.style.backgroundColor = '#f0fdf4'; // Light mint
            goalSection.style.borderLeft = '6px solid #1abc9c';
            goalSection.style.color = '#000';
        }

        // 4. Clean Table Rows
        const rows = clone.querySelectorAll('#tableBody tr');
        rows.forEach(row => {
             // Find original row to check values
             const origRowIndex = Array.from(row.parentNode.children).indexOf(row);
             const origRow = document.querySelectorAll('#tableBody tr')[origRowIndex];
             const maxVal = origRow.querySelector('.max').value;
             
             // Remove empty rows
             if(!maxVal) {
                 row.remove();
             } else {
                 // Remove Delete Button column
                 const delBtn = row.querySelector('.delete-btn');
                 if(delBtn) delBtn.parentElement.remove();
             }
        });
        // Remove header for delete column
        const headers = clone.querySelectorAll('th');
        if(headers.length > 0) headers[headers.length-1].remove();


        // 5. TEXT REPLACEMENT (Crucial Step)
        // Convert all inputs to static text div for perfect rendering
        const origInputs = originalContainer.querySelectorAll('input, select');
        const cloneInputs = clone.querySelectorAll('input, select');
        
        origInputs.forEach((input, i) => {
            if(cloneInputs[i]) {
                const value = input.value;
                const textSpan = document.createElement('div');
                textSpan.textContent = value;
                
                // Copy styles for font size/weight alignment
                textSpan.style.fontFamily = 'inherit';
                
                if (input.classList.contains('course-name-input')) {
                    textSpan.style.fontSize = '32px';
                    textSpan.style.fontWeight = '800';
                    textSpan.style.marginBottom = '10px';
                    textSpan.style.color = '#2c3e50';
                } else if (input.classList.contains('category-input')) {
                    textSpan.style.fontSize = '14px';
                    textSpan.style.fontWeight = '500';
                    textSpan.style.textAlign = 'left';
                } else {
                    textSpan.style.fontSize = '14px';
                    textSpan.style.textAlign = 'right';
                }

                // Replace input with text node
                cloneInputs[i].parentNode.replaceChild(textSpan, cloneInputs[i]);
            }
        });

        document.body.appendChild(clone);
        
        html2canvas(clone, {
            scale: 2, // Retina quality
            backgroundColor: '#ffffff',
            useCORS: true
        }).then(canvas => {
            const link = document.createElement('a');
            const name = document.getElementById('courseNameInput').value || "grade_report";
            link.download = `${name}.png`;
            link.href = canvas.toDataURL();
            link.click();
            document.body.removeChild(clone);
            closeShareModal();
        });
    }

    /* --- THEME LOGIC --- */
    function initTheme() {
        const savedTheme = localStorage.getItem('theme');
        const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (savedTheme === 'dark' || (!savedTheme && systemPrefersDark)) {
            document.documentElement.setAttribute('data-theme', 'dark');
            document.getElementById('themeBtn').innerText = 'üåô';
        } else {
            document.documentElement.setAttribute('data-theme', 'light');
            document.getElementById('themeBtn').innerText = '‚òÄÔ∏è';
        }
    }

    function toggleTheme() {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        document.getElementById('themeBtn').innerText = newTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
        if (statsModal.style.display === 'flex') { if(typeof window.loadDashboardStats === 'function') window.loadDashboardStats(); }
    }

    /* --- LOCAL STORAGE LOGIC --- */
    function saveData() {
        const data = {
            courseName: document.getElementById('courseNameInput').value,
            targetGrade: document.getElementById('targetGrade').value,
            rows: []
        };
        
        const rows = document.querySelectorAll('#tableBody tr');
        rows.forEach(row => {
            data.rows.push({
                name: row.querySelector('.category-input').value,
                earned: row.querySelector('.earned').value,
                max: row.querySelector('.max').value,
                weight: row.querySelector('.weight').value
            });
        });
        
        localStorage.setItem('gradeData', JSON.stringify(data));
    }

    function loadData() {
        const saved = localStorage.getItem('gradeData');
        if (saved) {
            try {
                const data = JSON.parse(saved);
                document.getElementById('courseNameInput').value = data.courseName || '';
                updatePageTitle(document.getElementById('courseNameInput'));
                
                if (data.targetGrade) document.getElementById('targetGrade').value = data.targetGrade;
                
                const tableBody = document.getElementById('tableBody');
                tableBody.innerHTML = ''; // Clear default rows
                
                if (data.rows && data.rows.length > 0) {
                    data.rows.forEach(rowData => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><input type="text" class="category-input" placeholder="Category Name" onchange="updateGoalDropdown()" oninput="saveData()" value="${rowData.name || ''}"></td>
                            <td><input type="text" class="num-input earned" placeholder="0" oninput="calculate(); saveData()" onfocus="handleFocus(this)" onblur="handleBlur(this)" value="${rowData.earned || ''}"></td>
                            <td><input type="text" class="num-input max" placeholder="0" oninput="calculate(); saveData()" onfocus="handleFocus(this)" onblur="handleBlur(this)" value="${rowData.max || ''}"></td>
                            <td class="row-percent">0.00%</td>
                            <td><input type="number" class="num-input weight" placeholder="0" oninput="calculate(); saveData()" value="${rowData.weight || ''}"></td>
                            <td><button class="delete-btn" onclick="removeRow(this)">√ó</button></td>
                        `;
                        tableBody.appendChild(row);
                    });
                } else {
                     // Fallback if rows empty
                     addRow(); addRow(); addRow();
                }
                
                calculate();
                updateGoalDropdown();
            } catch (e) {
                console.error("Error loading data", e);
                // Fallback
                initCalculator();
            }
        } else {
            // First time load
            initCalculator();
        }
    }

    /* --- CALCULATOR LOGIC --- */
    const tableBody = document.getElementById('tableBody');
    const finalGradeDisplay = document.getElementById('finalGrade');
    const weightDisplay = document.getElementById('weightDisplay');

    // Helper to evaluate simple math (e.g. "22+5")
    function parseScore(input) {
        if (!input) return 0;
        // Clean string: allow digits, dot, operators +, -, *, /, (, )
        const clean = input.toString().replace(/[^0-9\.\+\-\*\/\(\)]/g, '');
        if (!clean) return 0;
        try {
            // Check if it creates a valid number
            const result = new Function('return ' + clean)();
            return isFinite(result) ? result : 0;
        } catch (e) {
            return 0;
        }
    }

    /* --- INPUT FOCUS/BLUR HANDLERS --- */
    function handleFocus(input) {
        // When clicking in, show the raw formula if it exists (e.g. show "22+25" instead of "47")
        if (input.dataset.raw) {
            input.value = input.dataset.raw;
        }
    }

    function handleBlur(input) {
        // When leaving the box, save the formula and show the calculated result
        const rawValue = input.value;
        input.dataset.raw = rawValue;
        
        // Only calculate if not empty
        if (rawValue.trim() !== "") {
            const result = parseScore(rawValue);
            // Update the display to show the result (e.g. "47")
            // We strip decimals if it's a whole number for cleaner look
            input.value = Number.isInteger(result) ? result : result.toFixed(2);
        }
    }

    function updatePageTitle(input) {
        const val = input.value.trim();
        document.title = val ? val : "Grade Calculator";
        saveData(); // Save on title change
    }

    // initCalculator is now replaced by loadData() for initialization
    function initCalculator() { 
        const tableBody = document.getElementById('tableBody');
        if (tableBody.children.length === 0) {
             addRow(); addRow(); addRow(); 
        }
        calculate(); 
        updateGoalDropdown(); 
    }

    function addRow() {
        const row = document.createElement('tr');
        row.innerHTML = `<td><input type="text" class="category-input" placeholder="Category Name" onchange="updateGoalDropdown()" oninput="saveData()"></td><td><input type="text" class="num-input earned" placeholder="0" oninput="calculate(); saveData()" onfocus="handleFocus(this)" onblur="handleBlur(this)"></td><td><input type="text" class="num-input max" placeholder="0" oninput="calculate(); saveData()" onfocus="handleFocus(this)" onblur="handleBlur(this)"></td><td class="row-percent">0.00%</td><td><input type="number" class="num-input weight" placeholder="0" oninput="calculate(); saveData()"></td><td><button class="delete-btn" onclick="removeRow(this)">√ó</button></td>`;
        tableBody.appendChild(row);
        saveData();
    }

    function removeRow(btn) { 
        btn.closest('tr').remove(); 
        calculate(); 
        updateGoalDropdown(); 
        saveData();
    }

    function calculate() {
        let totalWeightedScore = 0, totalWeight = 0, totalMaxPointsForStats = 0, activeRows = 0, completeRows = 0;
        const rows = document.querySelectorAll('#tableBody tr');

        rows.forEach(row => {
            const earnedInput = row.querySelector('.earned');
            const maxInput = row.querySelector('.max');
            const weightInput = row.querySelector('.weight');
            const eVal = earnedInput.value, mVal = maxInput.value, wVal = weightInput.value;

            if (eVal !== '' || mVal !== '' || wVal !== '') {
                activeRows++;
                if (eVal !== '' && mVal !== '' && wVal !== '') completeRows++;
            }

            const earned = parseScore(eVal);
            const max = parseScore(mVal);
            const weight = parseFloat(wVal) || 0;
            const percentDisplay = row.querySelector('.row-percent');

            totalMaxPointsForStats += max;

            if (max > 0) {
                const p = (earned / max) * 100;
                percentDisplay.innerText = p.toFixed(2) + '%';
                totalWeightedScore += (earned / max) * weight;
                totalWeight += weight;
            } else { percentDisplay.innerText = 'N/A'; }
            if (weight > 0 && max === 0) totalWeight += weight;
        });

        weightDisplay.innerText = `Total Weight: ${totalWeight}%`;
        if (totalWeight !== 100 && totalWeight !== 0) weightDisplay.classList.add('total-weight-warning');
        else weightDisplay.classList.remove('total-weight-warning');

        finalGradeDisplay.innerText = totalWeightedScore.toFixed(2) + '%';
        
        const gradeInfo = getGradeInfo(totalWeightedScore);
        document.getElementById('finalGPA').innerText = gradeInfo.gpa;
        document.getElementById('finalLetter').innerText = gradeInfo.letter;

        const shouldRecord = activeRows > 0 && activeRows === completeRows;
        if (typeof window.recordCalculationStat === 'function' && shouldRecord) {
            window.recordCalculationStat(totalMaxPointsForStats, activeRows, parseFloat(gradeInfo.gpa));
        }
    }

    function updateGoalDropdown() {
        const select = document.getElementById('goalCategorySelect');
        const rows = document.querySelectorAll('#tableBody tr');
        // Preserve selection if possible
        const currentVal = select.value;
        
        select.innerHTML = '<option value="">Select a category...</option>';
        rows.forEach((row, index) => {
            const nameInput = row.querySelector('.category-input').value;
            const label = nameInput.trim() !== "" ? nameInput : `Row ${index + 1}`;
            const option = document.createElement('option');
            option.value = index; option.text = label;
            select.appendChild(option);
        });
        
        // Restore selection if index still valid
        if (currentVal !== "" && currentVal < rows.length) {
            select.value = currentVal;
        }
    }

    function calculateGoal() {
        const target = parseFloat(document.getElementById('targetGrade').value);
        const selectedIndex = document.getElementById('goalCategorySelect').value;
        const resultDiv = document.getElementById('goalResult');
        const goalSection = document.getElementById('goalSection'); // Ensure we target the element, not the wrapper here for inner logic, but wrapper for export.
        const goalSectionWrapper = document.getElementById('goalSectionWrapper');

        if (isNaN(target)) { resultDiv.innerHTML = "Please enter a valid target grade percentage."; return; }
        if (selectedIndex === "") { resultDiv.innerHTML = "Please select a category to calculate for."; return; }
        
        saveData(); // Save goal params

        let sumOfOthers = 0, targetMax = 0, targetWeight = 0, targetName = "";
        const rows = document.querySelectorAll('#tableBody tr');
        
        rows.forEach((row, index) => {
            const earned = parseScore(row.querySelector('.earned').value);
            const max = parseScore(row.querySelector('.max').value);
            const weight = parseFloat(row.querySelector('.weight').value) || 0;

            if (index == selectedIndex) {
                targetMax = max; targetWeight = weight; targetName = row.querySelector('.category-input').value || "Selected Category";
            } else {
                if (max > 0) sumOfOthers += (earned / max) * weight;
            }
        });

        if (targetWeight === 0 || targetMax === 0) {
            resultDiv.innerHTML = `Category <strong>${targetName}</strong> needs valid points/weight first.`; return;
        }

        const weightedPointsNeeded = target - sumOfOthers;
        const pointsNeeded = (weightedPointsNeeded / targetWeight) * targetMax;
        const percentageNeeded = (pointsNeeded / targetMax) * 100;

        resultDiv.innerHTML = `To get a <strong>${target}%</strong> overall, you need:<br><span style="font-size: 1.2em; color: var(--accent-hover);">${pointsNeeded.toFixed(2)} / ${targetMax} points (${percentageNeeded.toFixed(2)}%)</span><br>on <em>${targetName}</em>.`;
        
        // --- VISIBILITY TOGGLE FOR EXPORT ---
        goalSectionWrapper.classList.add('visible-in-export');

        // --- NEW FEATURE: Auto-fill the table box ---
        const targetRow = rows[selectedIndex];
        if (targetRow) {
            const earnedInput = targetRow.querySelector('.earned');
            if (earnedInput && earnedInput.value === "") { // Only fill if empty to avoid overwriting user data
                earnedInput.value = pointsNeeded.toFixed(2);
                earnedInput.style.transition = "background-color 0.3s";
                earnedInput.style.backgroundColor = "var(--mint-bg)";
                setTimeout(() => { earnedInput.style.backgroundColor = ""; }, 1000);
                saveData(); // Save the auto-filled value
            } else if (earnedInput && confirm(`Update ${targetName} score to ${pointsNeeded.toFixed(2)}?`)) {
                 earnedInput.value = pointsNeeded.toFixed(2);
                 saveData(); // Save the updated value
            }
        }
        calculate(); // Trigger stats
    }

    function clearAll() {
        if(confirm("Are you sure you want to clear all data?")) {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            document.getElementById('courseNameInput').value = '';
            document.getElementById('targetGrade').value = '';
            document.getElementById('goalResult').innerHTML = '';
            
            // Remove calculated class
            document.getElementById('goalSectionWrapper').classList.remove('visible-in-export');
            
            updatePageTitle({value: ''}); 
            localStorage.removeItem('gradeData');
            initCalculator();
        }
    }

    initTheme();
    // initCalculator(); // Replaced by loadData()
    loadData();
</script>

</body>
</html>