<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Grade Calculator</title>
    <!-- Chart.js for the Dashboard -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- html2canvas for Image Export -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        /* --- CSS VARIABLES (THEMING) --- */
        :root {
            --bg-color: #f4f7f6;
            --container-bg: #ffffff;
            --text-main: #333333;
            --text-secondary: #555555;
            --text-muted: #7f8c8d;
            --heading-color: #2c3e50;
            --border-color: #ecf0f1;
            --th-bg: #f8f9fa;
            --input-bg: #ffffff;
            --input-border: #cccccc;
            --input-text: #333333;
            --accent-color: #3498db;
            --accent-hover: #2980b9;
            --percent-text: #2980b9;
            --delete-btn: #e74c3c;
            --delete-hover: #c0392b;
            --result-box-bg: #ecf0f1;
            --goal-box-bg: #e8f6f3;
            --goal-border: #1abc9c;
            --shadow: 0 4px 15px rgba(0,0,0,0.1);

            /* Modal Styling */
            --modal-bg: #ffffff;
            --modal-text: #333333;
            --modal-border: #e0e0e0;
            --card-bg: #f8f9fa;
            --chart-grid: #e5e5e5;
            --chart-text: #666666;
            --close-btn-hover: #333333;
        }

        [data-theme="dark"] {
            --bg-color: #121212;
            --container-bg: #1e1e1e;
            --text-main: #e0e0e0;
            --text-secondary: #b0b0b0;
            --text-muted: #a0a0a0;
            --heading-color: #ffffff;
            --border-color: #333333;
            --th-bg: #2c2c2c;
            --input-bg: #2d2d2d;
            --input-border: #444444;
            --input-text: #ffffff;
            --accent-color: #3498db;
            --accent-hover: #5dade2;
            --percent-text: #5dade2;
            --delete-btn: #cf6679;
            --delete-hover: #b00020;
            --result-box-bg: #2d2d2d;
            --goal-box-bg: #1a3a34;
            --goal-border: #16a085;
            --shadow: 0 4px 15px rgba(0,0,0,0.5);

            /* Modal Styling Dark */
            --modal-bg: #1a1b26;
            --modal-text: #a9b1d6;
            --modal-border: #2f334d;
            --card-bg: #24283b;
            --chart-grid: #2f334d;
            --chart-text: #a9b1d6;
            --close-btn-hover: #ffffff;
        }

        /* FIX: Apply border-box globally */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            background-color: var(--container-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 900px;
            transition: background-color 0.3s;
            margin-bottom: 20px;
        }

        /* --- HEADER --- */
        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 20px;
            padding-bottom: 10px;
        }

        h2 { margin: 0; color: var(--heading-color); font-size: 1.5rem; }
        .report-date { display: none; }

        /* Course Name Input Styling */
        .course-name-input {
            display: block;
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--heading-color);
            background: transparent;
            border: 1px dashed var(--input-border);
            border-width: 0 0 1px 0;
            width: 100%;
            max-width: 400px;
            padding: 5px 0;
            margin-bottom: 5px;
            transition: border-color 0.3s;
        }
        .course-name-input:focus {
            outline: none;
            border-bottom: 2px solid var(--accent-color);
        }
        .course-name-input::placeholder {
            color: var(--text-muted);
            font-weight: normal;
            font-size: 1.5rem;
            font-style: italic;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .theme-toggle, .stats-btn {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-main);
            font-size: 16px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .theme-toggle:hover, .stats-btn:hover { background-color: var(--th-bg); }
        .stats-btn { font-size: 14px; font-weight: 600; }

        /* --- TABLE --- */
        .table-wrapper {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }

        th {
            text-align: left;
            padding: 12px;
            background-color: var(--th-bg);
            color: var(--text-secondary);
            font-weight: 600;
            border-bottom: 2px solid var(--border-color);
        }

        td {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
        }

        /* --- INPUTS --- */
        input[type="text"], input[type="number"], select {
            padding: 8px;
            border: 1px solid var(--input-border);
            background-color: var(--input-bg);
            color: var(--input-text);
            border-radius: 4px;
            width: 100%;
            font-size: 14px;
        }

        input[type="number"] { text-align: right; }
        .num-input { text-align: right; }
        .category-input { width: 100%; } 
        .num-input { width: 80px; }
        
        .row-percent {
            font-weight: bold;
            color: var(--percent-text);
            text-align: right;
        }

        /* --- CONTROLS --- */
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-top: 20px;
        }

        .buttons-left { display: flex; gap: 10px; flex-wrap: wrap; }

        button.btn-std {
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        button.add-btn { background-color: var(--accent-color); }
        button.add-btn:hover { background-color: var(--accent-hover); }

        button.share-btn { background-color: #27ae60; }
        button.share-btn:hover { background-color: #2ecc71; }

        button.clear-btn { background-color: #7f8c8d; }
        button.clear-btn:hover { background-color: #95a5a6; }

        button.delete-btn {
            background-color: var(--delete-btn);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
        }
        button.delete-btn:hover { background-color: var(--delete-hover); }

        /* --- RESULT BOX --- */
        .result-box {
            text-align: right;
            background-color: var(--result-box-bg);
            padding: 15px;
            border-radius: 8px;
            min-width: 200px;
        }

        .result-box div { margin-bottom: 5px; font-size: 14px; color: var(--text-muted); }
        .final-grade { font-size: 24px; font-weight: bold; color: var(--heading-color); }
        .total-weight-warning { color: #e67e22; font-weight: bold; }

        /* GPA and Letter Styling */
        .gpa-row {
            display: flex;
            justify-content: flex-end;
            gap: 20px;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
        }
        .mini-stat { text-align: center; }
        .mini-stat span { display: block; font-size: 12px; color: var(--text-muted); margin-bottom: 2px; }
        .mini-stat div { font-size: 18px; font-weight: bold; color: var(--accent-color); margin-bottom: 0 !important; }

        /* --- GOAL CALCULATOR SECTION --- */
        .goal-section {
            margin-top: 30px;
            padding: 20px;
            background-color: var(--goal-box-bg);
            border-left: 5px solid var(--goal-border);
            border-radius: 4px;
        }
        .goal-section h3 { margin-top: 0; color: var(--text-main); font-size: 18px; }
        .goal-controls { display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap; }
        .goal-input-group { display: flex; flex-direction: column; }
        .goal-input-group label { font-size: 12px; margin-bottom: 5px; color: var(--text-secondary); font-weight: 600; }
        button.calc-goal-btn { background-color: var(--goal-border); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: bold; height: 35px; }
        button.calc-goal-btn:hover { opacity: 0.9; }
        .goal-result { margin-top: 15px; font-weight: bold; color: var(--text-main); font-size: 16px; }

        /* --- EXPORT MENU MODAL --- */
        .export-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .export-option {
            background-color: var(--card-bg);
            border: 1px solid var(--modal-border);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--modal-text);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        .export-option:hover { background-color: var(--th-bg); transform: translateY(-2px); border-color: var(--accent-color); }
        .export-icon { font-size: 24px; margin-bottom: 5px; }
        .export-label { font-weight: 600; font-size: 14px; }

        /* --- STATS DASHBOARD MODAL (Shared Styles) --- */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-content { background-color: var(--modal-bg); color: var(--modal-text); width: 90%; max-width: 1000px; border-radius: 12px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); position: relative; max-height: 90vh; overflow-y: auto; border: 1px solid var(--modal-border); transition: background-color 0.3s, color 0.3s; }
        .modal-content.small-modal { max-width: 500px; } /* Smaller width for export menu */
        
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 1px solid var(--modal-border); padding-bottom: 15px; }
        .modal-header h2 { color: var(--modal-text); margin: 0; font-size: 24px; }
        .close-modal { background: none; border: none; color: var(--modal-text); opacity: 0.7; font-size: 28px; cursor: pointer; transition: opacity 0.2s; }
        .close-modal:hover { opacity: 1; color: var(--close-btn-hover); }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background-color: var(--card-bg); padding: 20px; border-radius: 8px; text-align: center; border: 1px solid var(--modal-border); transition: background-color 0.3s; }
        .stat-card h3 { font-size: 32px; margin: 0 0 5px 0; font-weight: 700; }
        .stat-card span { font-size: 12px; text-transform: uppercase; letter-spacing: 1px; opacity: 0.7; }
        
        .text-green { color: #10b981; } .text-orange { color: #f59e0b; } .text-purple { color: #8b5cf6; } .text-blue { color: #3498db; }
        .chart-container { background-color: var(--card-bg); padding: 20px; border-radius: 8px; border: 1px solid var(--modal-border); height: 350px; margin-bottom: 30px; transition: background-color 0.3s; }
        .history-table-container { background-color: var(--card-bg); border-radius: 8px; border: 1px solid var(--modal-border); padding: 20px; transition: background-color 0.3s; }
        .history-table { width: 100%; border-collapse: collapse; color: var(--modal-text); }
        .history-table th { text-align: left; padding: 10px; border-bottom: 1px solid var(--modal-border); color: var(--accent-color); font-size: 14px; }
        .history-table td { padding: 12px 10px; border-bottom: 1px solid var(--modal-border); font-size: 14px; }
        .history-table tr:last-child td { border-bottom: none; }
        .modal-footer { margin-top: 20px; display: flex; justify-content: center; }
        .modal-close-btn { background-color: var(--card-bg); color: var(--modal-text); border: 1px solid var(--modal-border); padding: 10px 30px; border-radius: 6px; cursor: pointer; transition: background-color 0.2s; }
        .modal-close-btn:hover { background-color: var(--th-bg); }

        /* --- MOBILE LAYOUT OPTIMIZATIONS --- */
        @media (max-width: 600px) {
            body { padding: 10px; }
            .container { padding: 15px; }
            .header-row { flex-direction: column; align-items: flex-start; gap: 15px; }
            .header-actions { width: 100%; justify-content: space-between; }
            .course-name-input { font-size: 1.5rem; }
            .controls { flex-direction: column; gap: 20px; }
            .buttons-left { width: 100%; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
            button.btn-std { width: 100%; padding: 12px 10px; font-size: 14px; }
            .result-box { width: 100%; text-align: center; }
            .gpa-row { justify-content: center; }
            .final-grade { font-size: 2rem; }
            .goal-controls { flex-direction: column; align-items: stretch; }
            .goal-input-group, #goalCategorySelect, #targetGrade { width: 100% !important; }
            .calc-goal-btn { margin-top: 10px; padding: 12px; }
            input, select, textarea { font-size: 16px !important; }
        }

        /* --- PRINT / PDF EXPORT STYLES --- */
        @media print {
            @page { margin: 0.75in; size: auto; }
            .buttons-left, .delete-btn, .header-actions, th:last-child, td:last-child, .stats-btn, .modal-overlay { display: none !important; }
            .goal-section { display: none; }
            .goal-section.goal-calculated { display: block !important; float: left !important; width: 55% !important; border: 1px solid #ddd !important; border-left: 4px solid #333 !important; background-color: #fafafa !important; color: #000 !important; padding: 15px !important; border-radius: 4px !important; box-sizing: border-box !important; margin-top: 0 !important; clear: none !important; }
            .goal-controls { display: none !important; }
            .goal-section h3 { margin-top: 0 !important; font-size: 16px !important; border-bottom: 1px solid #eee; padding-bottom: 8px; margin-bottom: 10px; color: #333 !important; }
            .goal-result { margin-top: 0 !important; color: #000 !important; font-size: 14px !important; line-height: 1.5 !important; }
            body { background-color: white !important; color: #222 !important; padding: 0 !important; margin: 0 !important; display: block !important; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif !important; }
            .container { box-shadow: none !important; width: 100% !important; max-width: 100% !important; padding: 0 !important; border: none !important; margin: 0 !important; }
            .header-row { border-bottom: 3px solid #000 !important; margin-bottom: 25px !important; padding-bottom: 10px !important; display: block !important; }
            h2 { display: none !important; } 
            .report-date { display: block !important; color: #555 !important; font-size: 14px !important; margin-top: 5px !important; }
            .course-name-input { border: none !important; background: transparent !important; font-size: 36px !important; font-weight: 800 !important; color: #000 !important; margin-bottom: 0 !important; padding: 0 !important; width: 100% !important; }
            .course-name-input::placeholder { color: transparent !important; }
            table { width: 100% !important; border-collapse: collapse !important; margin-bottom: 30px !important; }
            th { background-color: #f8f9fa !important; color: #000 !important; border-bottom: 2px solid #000 !important; border-top: 1px solid #ddd !important; padding: 12px 8px !important; text-transform: uppercase !important; font-size: 11px !important; font-weight: 700 !important; letter-spacing: 0.5px; }
            td { border-bottom: 1px solid #eee !important; padding: 12px 8px !important; color: #000 !important; font-size: 13px !important; }
            input { border: none !important; background: transparent !important; color: #000 !important; padding: 0 !important; font-weight: 500; font-family: inherit !important; font-size: 13px !important; }
            td:not(:first-child) input, th:not(:first-child), .row-percent { text-align: right !important; }
            .controls { display: block !important; margin-top: 0 !important; float: right !important; width: 40% !important; clear: none !important; }
            .result-box { float: none !important; width: 100% !important; background-color: #fff !important; border: 2px solid #000 !important; color: #000 !important; padding: 20px !important; border-radius: 6px !important; box-sizing: border-box !important; text-align: right !important; margin-right: 0 !important; }
            .result-box div { color: #555 !important; font-size: 14px !important; margin-bottom: 5px !important; }
            .final-grade { color: #000 !important; font-size: 36px !important; margin-top: 10px !important; font-weight: 800 !important; }
            .row-percent { color: #000 !important; }
        }
    </style>
</head>
<body>

<div class="container" id="mainAppContainer">
    <div class="header-row">
        <div>
            <!-- Course Name Input -->
            <input type="text" id="courseNameInput" class="course-name-input" placeholder="Enter Course Name..." oninput="updatePageTitle(this)">
            <h2>Course Grade Report</h2>
            <div class="report-date" id="reportDate"></div>
        </div>
        <div class="header-actions">
            <button class="stats-btn" id="openStatsBtn">üìä Community Stats</button>
            <button class="theme-toggle" id="themeBtn" onclick="toggleTheme()" title="Toggle Dark/Light Mode">‚òÄÔ∏è</button>
        </div>
    </div>
    
    <div class="table-wrapper">
        <table id="gradeTable">
            <thead>
                <tr>
                    <th>Category Name</th>
                    <th>Points Earned</th>
                    <th>Total Points</th>
                    <th>Current %</th>
                    <th>Weight (%)</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <!-- Rows injected by JS -->
            </tbody>
        </table>
    </div>

    <div class="controls">
        <div class="buttons-left">
            <button class="btn-std add-btn" onclick="addRow()">+ Add Category</button>
            <button class="btn-std clear-btn" onclick="clearAll()">Clear</button>
            <!-- REPLACED OLD BUTTONS WITH NEW EXPORT MENU BUTTON -->
            <button class="btn-std share-btn" onclick="openShareModal()">üì§ Export report</button>
        </div>
        
        <div class="result-box">
            <div id="weightDisplay">Total Weight: 0%</div>
            <div>Final Grade:</div>
            <div class="final-grade" id="finalGrade">0.00%</div>
            
            <div class="gpa-row">
                <div class="mini-stat">
                    <span>GPA</span>
                    <div id="finalGPA">0.0</div>
                </div>
                <div class="mini-stat">
                    <span>Letter</span>
                    <div id="finalLetter">F</div>
                </div>
            </div>
        </div>
    </div>

    <!-- GOAL CALCULATOR SECTION -->
    <div class="goal-section" id="goalSection">
        <h3>üèÜ Goal Calculator</h3>
        <div class="goal-controls">
            <div class="goal-input-group">
                <label>Target Grade (%)</label>
                <input type="number" id="targetGrade" placeholder="90" style="width: 100px;">
            </div>
            <div class="goal-input-group">
                <label>Calculate For Category</label>
                <select id="goalCategorySelect" onmousedown="updateGoalDropdown()" style="width: 250px;">
                    <option value="">Select a category...</option>
                </select>
            </div>
            <button class="calc-goal-btn" onclick="calculateGoal()">Calculate Needed Score</button>
        </div>
        <div class="goal-result" id="goalResult"></div>
    </div>
</div>

<!-- SHARE MENU MODAL -->
<div class="modal-overlay" id="shareModal">
    <div class="modal-content small-modal">
        <div class="modal-header">
            <h2>Share / Export</h2>
            <button class="close-modal" onclick="closeShareModal()">√ó</button>
        </div>
        
        <div class="export-grid">
            <div class="export-option" onclick="window.recordExportStat()">
                <div class="export-icon">üìÑ</div>
                <div class="export-label">Save as PDF</div>
            </div>
            <div class="export-option" onclick="emailReport()">
                <div class="export-icon">üìß</div>
                <div class="export-label">Email Report</div>
            </div>
            <div class="export-option" onclick="copyToClipboard()">
                <div class="export-icon">üìã</div>
                <div class="export-label">Copy Text</div>
            </div>
            <div class="export-option" onclick="downloadImage()">
                <div class="export-icon">üñºÔ∏è</div>
                <div class="export-label">Save Image</div>
            </div>
            <div class="export-option" onclick="downloadCSV()">
                <div class="export-icon">üìä</div>
                <div class="export-label">Download CSV</div>
            </div>
        </div>

        <div class="modal-footer">
            <button class="modal-close-btn" onclick="closeShareModal()">Cancel</button>
        </div>
    </div>
</div>

<!-- STATS MODAL DASHBOARD -->
<div class="modal-overlay" id="statsModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Community Statistics</h2>
            <button class="close-modal" onclick="closeStats()">√ó</button>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h3 class="text-green" id="dashGrades">0</h3>
                <span>Grades Calculated</span>
            </div>
            <div class="stat-card">
                <h3 class="text-orange" id="dashPoints">0</h3>
                <span>Total Points</span>
            </div>
            <div class="stat-card">
                <h3 class="text-purple" id="dashExports">0</h3>
                <span>Reports Exported</span>
            </div>
            <div class="stat-card">
                <h3 class="text-blue" id="dashAvgGrade">-</h3>
                <span>Average Grade</span>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="statsChart"></canvas>
        </div>

        <div class="history-table-container">
            <h3>History by Month</h3>
            <table class="history-table">
                <thead>
                    <tr>
                        <th>Month</th>
                        <th>Grades Calculated</th>
                        <th>Total Points</th>
                        <th>Reports Exported</th>
                    </tr>
                </thead>
                <tbody id="historyTableBody"></tbody>
            </table>
        </div>

        <div class="modal-footer">
            <button class="modal-close-btn" onclick="closeStats()">Close</button>
        </div>
    </div>
</div>


<!-- FIREBASE MODULE -->
<script type="module">
    // Import Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, onValue, update, increment, get, child } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAnFiOGWezksnsxJlukAEul6XbCmLYoQno",
        authDomain: "grade-calculator-c4684.firebaseapp.com",
        databaseURL: "https://grade-calculator-c4684-default-rtdb.firebaseio.com",
        projectId: "grade-calculator-c4684",
        storageBucket: "grade-calculator-c4684.firebasestorage.app",
        messagingSenderId: "721967682600",
        appId: "1:721967682600:web:2583b99028f5cd4e19111d"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    function getMonthKey() {
        const d = new Date();
        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
    }

    function isLocalhost() {
        return window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
    }

    let debounceTimer;
    let sessionMaxCategories = 0; 
    let sessionMaxPoints = 0;

    window.recordCalculationStat = function(currentTotalPoints, categoryCount, currentGPA) {
        if (isLocalhost()) return;

        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            if (currentTotalPoints > 0) {
                const monthKey = getMonthKey();
                const updates = {};
                
                let categoriesToAdd = 0;
                if (categoryCount > sessionMaxCategories) {
                    categoriesToAdd = categoryCount - sessionMaxCategories;
                    sessionMaxCategories = categoryCount;
                }

                let pointsToAdd = 0;
                if (currentTotalPoints > sessionMaxPoints) {
                    pointsToAdd = currentTotalPoints - sessionMaxPoints;
                    sessionMaxPoints = currentTotalPoints;
                }

                updates['stats/global/grades_calculated'] = increment(1);
                if (currentGPA >= 0) updates['stats/global/total_gpa_sum'] = increment(currentGPA);
                if (pointsToAdd > 0) updates['stats/global/total_points'] = increment(pointsToAdd);
                if (categoriesToAdd > 0) updates['stats/global/total_categories'] = increment(categoriesToAdd);
                
                updates[`stats/monthly/${monthKey}/grades_calculated`] = increment(1);
                if (currentGPA >= 0) updates[`stats/monthly/${monthKey}/total_gpa_sum`] = increment(currentGPA);
                if (pointsToAdd > 0) updates[`stats/monthly/${monthKey}/total_points`] = increment(pointsToAdd);
                if (categoriesToAdd > 0) updates[`stats/monthly/${monthKey}/total_categories`] = increment(categoriesToAdd);

                update(ref(db), updates);
            }
        }, 3000);
    };

    window.recordExportStat = function() {
        window.print();
        if (isLocalhost()) return;
        const monthKey = getMonthKey();
        const updates = {};
        updates['stats/global/reports_exported'] = increment(1);
        updates[`stats/monthly/${monthKey}/reports_exported`] = increment(1);
        update(ref(db), updates);
    };

    function getLetterFromGPA(gpa) {
        if (gpa >= 4.0) return 'A'; if (gpa >= 3.7) return 'A-'; if (gpa >= 3.3) return 'B+';
        if (gpa >= 3.0) return 'B'; if (gpa >= 2.7) return 'B-'; if (gpa >= 2.3) return 'C+';
        if (gpa >= 2.0) return 'C'; if (gpa >= 1.7) return 'C-'; if (gpa >= 1.3) return 'D+';
        if (gpa >= 1.0) return 'D'; if (gpa >= 0.7) return 'D-'; return 'F';
    }

    window.loadDashboardStats = async function() {
        const dbRef = ref(db);
        try {
            const snapshot = await get(child(dbRef, 'stats'));
            if (snapshot.exists()) {
                const data = snapshot.val();
                const global = data.global || {};
                const monthly = data.monthly || {};

                document.getElementById('dashGrades').innerText = (global.grades_calculated || 0).toLocaleString();
                document.getElementById('dashPoints').innerText = (global.total_points || 0).toLocaleString();
                document.getElementById('dashExports').innerText = (global.reports_exported || 0).toLocaleString();

                if (global.grades_calculated > 0 && global.total_gpa_sum > 0) {
                    const avgGpa = global.total_gpa_sum / global.grades_calculated;
                    const letter = getLetterFromGPA(avgGpa);
                    document.getElementById('dashAvgGrade').innerText = `${letter} (${avgGpa.toFixed(2)})`;
                } else {
                    document.getElementById('dashAvgGrade').innerText = "N/A";
                }

                const months = Object.keys(monthly).sort();
                const labels = [], gradeData = [], pointsData = [], exportData = [];
                const tbody = document.getElementById('historyTableBody');
                tbody.innerHTML = '';

                months.forEach(m => {
                    labels.push(m);
                    gradeData.push(monthly[m].grades_calculated || 0);
                    pointsData.push(monthly[m].total_points || 0);
                    exportData.push(monthly[m].reports_exported || 0);
                });

                [...months].reverse().forEach(m => {
                    const row = monthly[m];
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${m}</td><td class="text-green">${(row.grades_calculated||0).toLocaleString()}</td><td class="text-orange">${(row.total_points||0).toLocaleString()}</td><td class="text-purple">${(row.reports_exported||0).toLocaleString()}</td>`;
                    tbody.appendChild(tr);
                });

                renderChart(labels, gradeData, exportData, pointsData);
            }
        } catch (error) { console.error(error); }
    }
</script>

<script>
    // --- UI LOGIC ---
    document.getElementById('reportDate').innerText = new Date().toLocaleDateString();

    /* --- CHART JS SETUP --- */
    let myChart = null;
    function renderChart(labels, gradeData, exportData, pointsData) {
        const ctx = document.getElementById('statsChart').getContext('2d');
        if (myChart) myChart.destroy();
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        const gridColor = isDark ? '#2f334d' : '#e5e5e5';
        const textColor = isDark ? '#a9b1d6' : '#666666';
        Chart.defaults.color = textColor;
        Chart.defaults.borderColor = gridColor;

        myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    { label: 'Grades Calculated', data: gradeData, backgroundColor: 'rgba(16, 185, 129, 0.7)', borderColor: '#10b981', borderWidth: 1, yAxisID: 'y', order: 2 },
                    { label: 'Total Points', data: pointsData, type: 'line', borderColor: '#f59e0b', backgroundColor: '#f59e0b', tension: 0.4, yAxisID: 'y2', order: 0 },
                    { label: 'Reports Exported', data: exportData, type: 'line', borderColor: '#8b5cf6', backgroundColor: '#8b5cf6', tension: 0.4, yAxisID: 'y1', order: 1 }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
                plugins: { legend: { position: 'top', labels: { color: textColor } } },
                scales: {
                    x: { ticks: { color: textColor }, grid: { color: gridColor } },
                    y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Grades', color: '#10b981' }, ticks: { color: '#10b981' }, grid: { color: gridColor } },
                    y1: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'Exports', color: '#8b5cf6' }, ticks: { color: '#8b5cf6' }, grid: { drawOnChartArea: false } },
                    y2: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'Points', color: '#f59e0b' }, ticks: { color: '#f59e0b' }, grid: { drawOnChartArea: false } }
                }
            }
        });
    }

    /* --- MODAL LOGIC (Stats & Share) --- */
    const statsModal = document.getElementById('statsModal');
    const shareModal = document.getElementById('shareModal');
    
    document.getElementById('openStatsBtn').onclick = function() {
        statsModal.style.display = 'flex';
        if(typeof window.loadDashboardStats === 'function') window.loadDashboardStats();
    };
    function closeStats() { statsModal.style.display = 'none'; }

    function openShareModal() { shareModal.style.display = 'flex'; }
    function closeShareModal() { shareModal.style.display = 'none'; }

    window.onclick = function(event) {
        if (event.target == statsModal) closeStats();
        if (event.target == shareModal) closeShareModal();
    };

    /* --- NEW EXPORT FUNCTIONS --- */
    
    // Helper: Generate summary text
    function getSummaryText() {
        const courseName = document.getElementById('courseNameInput').value || "Course Grade Report";
        const finalGrade = document.getElementById('finalGrade').innerText;
        let text = `Course: ${courseName}\nFinal Grade: ${finalGrade}\n\n`;
        
        const rows = document.querySelectorAll('#tableBody tr');
        rows.forEach(row => {
            const cat = row.querySelector('.category-input').value || "Category";
            const earned = row.querySelector('.earned').value || 0;
            const max = row.querySelector('.max').value || 0;
            const weight = row.querySelector('.weight').value || 0;
            text += `- ${cat}: ${earned}/${max} (Weight: ${weight}%)\n`;
        });
        
        const goalText = document.getElementById('goalResult').innerText;
        if (goalText && goalText.trim().length > 0) {
            const cleanGoal = goalText.replace(/\n+/g, ' ').trim();
            text += `\nGoal Analysis: ${cleanGoal}`;
        }
        return text;
    }

    function copyToClipboard() {
        const text = getSummaryText();
        navigator.clipboard.writeText(text).then(() => {
            alert("Report copied to clipboard!");
            closeShareModal();
        });
    }

    function emailReport() {
        const text = getSummaryText();
        const courseName = document.getElementById('courseNameInput').value || "Course Grade Report";
        const subject = encodeURIComponent(`${courseName} - Grade Report`);
        const bodyEnc = encodeURIComponent(text);
        window.location.href = `mailto:?subject=${subject}&body=${bodyEnc}`;
        closeShareModal();
    }

    function downloadCSV() {
        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "Category Name,Points Earned,Total Points,Weight (%)\n";
        
        const rows = document.querySelectorAll('#tableBody tr');
        rows.forEach(row => {
            const cat = row.querySelector('.category-input').value || "";
            const earned = row.querySelector('.earned').value || 0;
            const max = row.querySelector('.max').value || 0;
            const weight = row.querySelector('.weight').value || 0;
            // Escape commas in category name
            const safeCat = cat.includes(',') ? `"${cat}"` : cat;
            csvContent += `${safeCat},${earned},${max},${weight}\n`;
        });
        
        csvContent += `\nFinal Grade,,${document.getElementById('finalGrade').innerText},`;

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        const name = document.getElementById('courseNameInput').value || "grade_report";
        link.setAttribute("download", `${name}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        closeShareModal();
    }

    function downloadImage() {
        // Use html2canvas to capture the main container
        const container = document.getElementById('mainAppContainer');
        
        // Hide buttons temporarily for clean screenshot
        const controls = document.querySelector('.controls');
        const btns = controls.querySelector('.buttons-left');
        const themeBtn = document.querySelector('.header-actions');
        
        btns.style.display = 'none';
        themeBtn.style.display = 'none';
        
        html2canvas(container).then(canvas => {
            // Restore buttons
            btns.style.display = 'flex';
            themeBtn.style.display = 'flex';
            
            const link = document.createElement('a');
            const name = document.getElementById('courseNameInput').value || "grade_report";
            link.download = `${name}.png`;
            link.href = canvas.toDataURL();
            link.click();
            closeShareModal();
        });
    }

    /* --- THEME LOGIC --- */
    function initTheme() {
        const savedTheme = localStorage.getItem('theme');
        const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (savedTheme === 'dark' || (!savedTheme && systemPrefersDark)) {
            document.documentElement.setAttribute('data-theme', 'dark');
            document.getElementById('themeBtn').innerText = 'üåô';
        } else {
            document.documentElement.setAttribute('data-theme', 'light');
            document.getElementById('themeBtn').innerText = '‚òÄÔ∏è';
        }
    }

    function toggleTheme() {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        document.getElementById('themeBtn').innerText = newTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
        if (statsModal.style.display === 'flex') { if(typeof window.loadDashboardStats === 'function') window.loadDashboardStats(); }
    }

    /* --- CALCULATOR LOGIC --- */
    const tableBody = document.getElementById('tableBody');
    const finalGradeDisplay = document.getElementById('finalGrade');
    const weightDisplay = document.getElementById('weightDisplay');

    function parseScore(input) {
        if (!input) return 0;
        const clean = input.toString().replace(/[^0-9\.\+\-\*\/\(\)]/g, '');
        if (!clean) return 0;
        try {
            const result = new Function('return ' + clean)();
            return isFinite(result) ? result : 0;
        } catch (e) { return 0; }
    }

    function handleFocus(input) { if (input.dataset.raw) input.value = input.dataset.raw; }
    function handleBlur(input) {
        const rawValue = input.value;
        input.dataset.raw = rawValue;
        if (rawValue.trim() !== "") {
            const result = parseScore(rawValue);
            input.value = Number.isInteger(result) ? result : result.toFixed(2);
        }
    }

    function updatePageTitle(input) {
        const val = input.value.trim();
        document.title = val ? val : "Grade Calculator";
    }

    function initCalculator() { addRow(); addRow(); addRow(); calculate(); updateGoalDropdown(); }

    function addRow() {
        const row = document.createElement('tr');
        row.innerHTML = `<td><input type="text" class="category-input" placeholder="Category Name" onchange="updateGoalDropdown()"></td><td><input type="text" class="num-input earned" placeholder="0" oninput="calculate()" onfocus="handleFocus(this)" onblur="handleBlur(this)"></td><td><input type="text" class="num-input max" placeholder="0" oninput="calculate()" onfocus="handleFocus(this)" onblur="handleBlur(this)"></td><td class="row-percent">0.00%</td><td><input type="number" class="num-input weight" placeholder="0" oninput="calculate()"></td><td><button class="delete-btn" onclick="removeRow(this)">√ó</button></td>`;
        tableBody.appendChild(row);
    }

    function removeRow(btn) { btn.closest('tr').remove(); calculate(); updateGoalDropdown(); }

    function calculate() {
        let totalWeightedScore = 0, totalWeight = 0, totalMaxPointsForStats = 0, activeRows = 0, completeRows = 0;
        const rows = document.querySelectorAll('#tableBody tr');

        rows.forEach(row => {
            const earnedInput = row.querySelector('.earned');
            const maxInput = row.querySelector('.max');
            const weightInput = row.querySelector('.weight');
            const eVal = earnedInput.value, mVal = maxInput.value, wVal = weightInput.value;

            if (eVal !== '' || mVal !== '' || wVal !== '') {
                activeRows++;
                if (eVal !== '' && mVal !== '' && wVal !== '') completeRows++;
            }

            const earned = parseScore(eVal);
            const max = parseScore(mVal);
            const weight = parseFloat(wVal) || 0;
            const percentDisplay = row.querySelector('.row-percent');

            totalMaxPointsForStats += max;

            if (max > 0) {
                const p = (earned / max) * 100;
                percentDisplay.innerText = p.toFixed(2) + '%';
                totalWeightedScore += (earned / max) * weight;
                totalWeight += weight;
            } else { percentDisplay.innerText = 'N/A'; }
            if (weight > 0 && max === 0) totalWeight += weight;
        });

        weightDisplay.innerText = `Total Weight: ${totalWeight}%`;
        if (totalWeight !== 100 && totalWeight !== 0) weightDisplay.classList.add('total-weight-warning');
        else weightDisplay.classList.remove('total-weight-warning');

        finalGradeDisplay.innerText = totalWeightedScore.toFixed(2) + '%';
        
        const gradeInfo = getGradeInfo(totalWeightedScore);
        document.getElementById('finalGPA').innerText = gradeInfo.gpa;
        document.getElementById('finalLetter').innerText = gradeInfo.letter;

        const shouldRecord = activeRows > 0 && activeRows === completeRows;
        if (typeof window.recordCalculationStat === 'function' && shouldRecord) {
            window.recordCalculationStat(totalMaxPointsForStats, activeRows, parseFloat(gradeInfo.gpa));
        }
    }

    function updateGoalDropdown() {
        const select = document.getElementById('goalCategorySelect');
        const rows = document.querySelectorAll('#tableBody tr');
        const currentVal = select.value;
        select.innerHTML = '<option value="">Select a category...</option>';
        rows.forEach((row, index) => {
            const nameInput = row.querySelector('.category-input').value;
            const label = nameInput.trim() !== "" ? nameInput : `Row ${index + 1}`;
            const option = document.createElement('option');
            option.value = index; option.text = label;
            select.appendChild(option);
        });
        select.value = currentVal;
    }

    function calculateGoal() {
        const target = parseFloat(document.getElementById('targetGrade').value);
        const selectedIndex = document.getElementById('goalCategorySelect').value;
        const resultDiv = document.getElementById('goalResult');
        const goalSection = document.getElementById('goalSection');

        if (isNaN(target)) { resultDiv.innerHTML = "Please enter a valid target grade percentage."; return; }
        if (selectedIndex === "") { resultDiv.innerHTML = "Please select a category to calculate for."; return; }

        let sumOfOthers = 0, targetMax = 0, targetWeight = 0, targetName = "";
        const rows = document.querySelectorAll('#tableBody tr');
        
        rows.forEach((row, index) => {
            const earned = parseScore(row.querySelector('.earned').value);
            const max = parseScore(row.querySelector('.max').value);
            const weight = parseFloat(row.querySelector('.weight').value) || 0;

            if (index == selectedIndex) {
                targetMax = max; targetWeight = weight; targetName = row.querySelector('.category-input').value || "Selected Category";
            } else {
                if (max > 0) sumOfOthers += (earned / max) * weight;
            }
        });

        if (targetWeight === 0 || targetMax === 0) {
            resultDiv.innerHTML = `Category <strong>${targetName}</strong> needs valid points/weight first.`; return;
        }

        const weightedPointsNeeded = target - sumOfOthers;
        const pointsNeeded = (weightedPointsNeeded / targetWeight) * targetMax;
        const percentageNeeded = (pointsNeeded / targetMax) * 100;

        resultDiv.innerHTML = `To get a <strong>${target}%</strong> overall, you need:<br><span style="font-size: 1.2em; color: var(--accent-hover);">${pointsNeeded.toFixed(2)} / ${targetMax} points (${percentageNeeded.toFixed(2)}%)</span><br>on <em>${targetName}</em>.`;
        goalSection.classList.add('goal-calculated');
    }

    initTheme();
    initCalculator();
</script>

</body>
</html>